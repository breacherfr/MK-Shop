<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK SHOP - SUPREME SYSTEM V63</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        mkBlue: '#00d2ff',
                        mkRed: '#ff4b5c',
                        mkPurple: '#a363ff',
                        mkYellow: '#fbbf24',
                        mkGreen: '#22c55e',
                        mkAdmin: '#ff00ff',
                        mkDark: '#050505',
                        mkLight: '#f3f4f6'
                    },
                    fontFamily: { sans: ['Montserrat', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        /* BASE STYLES */
        body { transition: background-color 0.3s, color 0.3s; overflow-x: hidden; }
        .glass { backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .dark .glass { background: rgba(20, 20, 25, 0.8); }
        .light .glass { background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(0, 0, 0, 0.05); }

        /* CUSTOM ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #00d2ff; border-radius: 10px; }

        /* TOAST SYSTEM */
        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 16px 24px; border-radius: 12px; font-weight: 800; font-size: 12px; color: white; display: flex; align-items: center; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* TAGS */
        .chat-tag { font-size: 9px; padding: 2px 8px; border-radius: 4px; font-weight: 900; text-transform: uppercase; margin-right: 6px; }
        
        /* SLOTS ANIMATION */
        .slot-spinning { animation: blur 0.1s infinite linear; }
        @keyframes blur { 0% { filter: blur(0px); } 50% { filter: blur(4px); } 100% { filter: blur(0px); } }
    </style>
</head>
<body class="dark bg-mkDark text-white light:bg-mkLight light:text-mkDark">

    <div id="notification-container"></div>

    <nav class="glass sticky top-0 z-[100] px-8 py-4 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="showSection('shop')">
                <div class="w-12 h-12 bg-mkBlue rounded-2xl flex items-center justify-center font-black text-black group-hover:scale-110 transition">MK</div>
                <div class="flex flex-col">
                    <span class="font-black text-xl italic leading-none">MK SHOP</span>
                    <span class="text-[9px] font-bold text-mkBlue tracking-[0.2em]">ULTIMATE</span>
                </div>
            </div>
            
            <div class="hidden lg:flex gap-2">
                <button onclick="showSection('shop')" class="nav-btn px-4 py-2 text-[10px] font-black uppercase hover:text-mkBlue transition">Boutique</button>
                <button onclick="showSection('gamble')" class="nav-btn px-4 py-2 text-[10px] font-black uppercase hover:text-mkBlue transition">Casino</button>
                <button onclick="showSection('leaderboard')" class="nav-btn px-4 py-2 text-[10px] font-black uppercase hover:text-mkBlue transition">Classement</button>
                <button onclick="showSection('profile')" class="nav-btn px-4 py-2 text-[10px] font-black uppercase hover:text-mkBlue transition">Mon Profil</button>
                <button id="nav-admin" onclick="showSection('admin')" class="hidden px-4 py-2 text-[10px] font-black uppercase text-mkAdmin border border-mkAdmin/30 rounded-lg hover:bg-mkAdmin hover:text-black transition">Panel Admin</button>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <button onclick="toggleTheme()" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-lg hover:bg-white/10 transition">üåì</button>
            
            <div class="flex items-center bg-black/40 rounded-2xl p-1 border border-white/10">
                <button onclick="setActiveStat('cash')" id="btn-stat-cash" class="px-4 py-2 rounded-xl text-[11px] font-black bg-mkGreen text-black transition">CASH</button>
                <button onclick="setActiveStat('xp')" id="btn-stat-xp" class="px-4 py-2 rounded-xl text-[11px] font-black opacity-40 transition">XP</button>
            </div>

            <div class="bg-black/20 px-6 py-2.5 rounded-2xl border border-white/5 min-w-[120px] text-center">
                <span id="top-display-val" class="font-black text-lg text-mkGreen">0.00‚Ç¨</span>
            </div>

            <div id="user-controls" class="hidden flex items-center gap-3">
                <img id="nav-pfp" src="" class="w-10 h-10 rounded-xl border-2 border-mkBlue object-cover">
                <button onclick="logout()" class="w-10 h-10 flex items-center justify-center text-mkRed hover:bg-mkRed/10 rounded-xl transition">‚úï</button>
            </div>
            
            <button id="login-trigger" onclick="openModal('auth-modal')" class="bg-mkBlue text-black px-6 py-3 rounded-xl font-black text-xs uppercase hover:bg-cyan-400 transition">Connexion</button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-12 lg:pr-[400px]">

        <section id="section-shop" class="content-view space-y-12 animate-fade">
            <header>
                <h2 class="text-5xl font-black italic uppercase tracking-tighter">Boutique <span class="text-mkBlue">Exclusive</span></h2>
                <p class="text-white/40 font-bold mt-2 uppercase text-xs">Les meilleurs produits Roblox et Premium du march√©.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass p-8 rounded-[2.5rem] border-t-8 border-mkBlue hover:translate-y-[-5px] transition-all">
                    <span class="bg-mkBlue/10 text-mkBlue px-3 py-1 rounded text-[9px] font-black uppercase">Instantan√©</span>
                    <h3 class="text-2xl font-black mt-4">COMPTES ROBLOX</h3>
                    <p class="text-xs opacity-50 mt-2 leading-relaxed">Acc√®s √† des comptes avec skins rares, Robux et anciens badges de collection.</p>
                    <button onclick="openTicket('Achat Roblox')" class="w-full mt-8 bg-white text-black py-4 rounded-2xl font-black text-xs uppercase hover:scale-[1.02] transition">Consulter les prix</button>
                </div>
                <div class="glass p-8 rounded-[2.5rem] border-t-8 border-mkBlue hover:translate-y-[-5px] transition-all">
                    <span class="bg-mkBlue/10 text-mkBlue px-3 py-1 rounded text-[9px] font-black uppercase">S√©curis√©</span>
                    <h3 class="text-2xl font-black mt-4">ROBLOX CHEATS</h3>
                    <p class="text-xs opacity-50 mt-2 leading-relaxed">Scripts, executors et bypass pour dominer tous les jeux sans risque de ban.</p>
                    <button onclick="openTicket('Achat Cheat')" class="w-full mt-8 bg-white text-black py-4 rounded-2xl font-black text-xs uppercase hover:scale-[1.02] transition">Voir le catalogue</button>
                </div>
                <div class="glass p-8 rounded-[2.5rem] border-t-8 border-mkYellow hover:translate-y-[-5px] transition-all">
                    <span class="bg-mkYellow/10 text-mkYellow px-3 py-1 rounded text-[9px] font-black uppercase">Premium</span>
                    <h3 class="text-2xl font-black mt-4">COMPTES STREAMING</h3>
                    <p class="text-xs opacity-50 mt-2 leading-relaxed">Netflix 4K, Disney+, Spotify Premium √† prix cass√©s garantis √† vie.</p>
                    <button onclick="openTicket('Achat Premium')" class="w-full mt-8 bg-mkYellow text-black py-4 rounded-2xl font-black text-xs uppercase hover:scale-[1.02] transition">Acheter maintenant</button>
                </div>
                <div id="shop-tv-card" class="glass p-8 rounded-[2.5rem] border-t-8 border-mkPurple hover:translate-y-[-5px] transition-all">
                    <span class="bg-mkPurple/10 text-mkPurple px-3 py-1 rounded text-[9px] font-black uppercase">Multim√©dia</span>
                    <h3 class="text-2xl font-black mt-4">ACC√àS TV FILMS</h3>
                    <p class="text-xs opacity-50 mt-2 leading-relaxed">Regardez tous les derniers films et anim√©s directement sur MK SHOP.</p>
                    <div id="tv-activation-ui" class="mt-8 space-y-3">
                        <input id="tv-code-input" type="text" placeholder="Entrez votre code TV..." class="w-full bg-black/30 p-4 rounded-xl text-xs outline-none border border-white/5 focus:border-mkPurple/50">
                        <button onclick="activateTV()" class="w-full bg-mkPurple text-white py-4 rounded-2xl font-black text-xs uppercase">Activer l'acc√®s</button>
                    </div>
                </div>
            </div>

            <div class="glass p-10 rounded-[3rem] border-2 border-mkRed flex flex-col lg:flex-row items-center justify-between gap-8 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-8 opacity-10 pointer-events-none text-8xl">üõ°Ô∏è</div>
                <div class="relative z-10 text-center lg:text-left">
                    <h3 class="text-3xl font-black text-mkRed uppercase italic">Support & Cashout</h3>
                    <p class="text-sm font-bold opacity-60 mt-1 uppercase">Besoin d'aide ou pr√™t √† retirer vos gains ?</p>
                </div>
                <div class="flex flex-wrap justify-center gap-4 relative z-10">
                    <button onclick="openTicket('Support Technique')" class="bg-white/10 hover:bg-white/20 px-8 py-4 rounded-2xl font-black text-xs uppercase transition">Ticket Support</button>
                    <button onclick="openTicket('Demande Cashout')" class="bg-mkRed text-white px-10 py-4 rounded-2xl font-black text-xs uppercase shadow-xl shadow-mkRed/30 hover:scale-105 transition">üí∞ Retirer Cash</button>
                </div>
            </div>
        </section>

        <section id="section-gamble" class="content-view hidden space-y-10 animate-fade">
            <header>
                <h2 class="text-5xl font-black italic uppercase tracking-tighter">Casino <span class="text-mkRed">MK</span></h2>
                <p class="text-white/40 font-bold mt-2 uppercase text-xs">Multipliez votre argent avec nos jeux √©quitables.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass p-8 rounded-[2.5rem] text-center space-y-6">
                    <div class="text-6xl mx-auto w-24 h-24 bg-mkBlue/10 rounded-full flex items-center justify-center">ü™ô</div>
                    <div>
                        <h4 class="text-xl font-black uppercase">Pile ou Face</h4>
                        <p class="text-[10px] opacity-50">50% de chance de doubler votre mise.</p>
                    </div>
                    <div class="space-y-3">
                        <input id="bet-coin" type="number" value="1" min="1" class="w-full bg-black/40 p-4 rounded-2xl text-center font-black text-mkGreen outline-none border border-white/5">
                        <div class="flex gap-2">
                            <button onclick="playCoin('pile')" class="flex-1 bg-mkBlue text-black py-4 rounded-xl font-black text-[10px] uppercase">Miser Pile</button>
                            <button onclick="playCoin('face')" class="flex-1 bg-mkBlue text-black py-4 rounded-xl font-black text-[10px] uppercase">Miser Face</button>
                        </div>
                    </div>
                </div>

                <div class="glass p-8 rounded-[2.5rem] text-center space-y-6">
                    <div id="slot-machine" class="flex justify-center gap-4 text-5xl py-6 bg-black/40 rounded-3xl border border-white/5">
                        <span id="slot1">üçí</span><span id="slot2">üçí</span><span id="slot3">üçí</span>
                    </div>
                    <div>
                        <h4 class="text-xl font-black uppercase">Jackpot Slots</h4>
                        <p class="text-[10px] opacity-50">Gagnez jusqu'√† x10 votre mise.</p>
                    </div>
                    <div class="space-y-3">
                        <input id="bet-slots" type="number" value="1" min="1" class="w-full bg-black/40 p-4 rounded-2xl text-center font-black text-mkPurple outline-none border border-white/5">
                        <button onclick="playSlots()" class="w-full bg-mkPurple text-white py-4 rounded-xl font-black text-[10px] uppercase">Lancer les rouleaux</button>
                    </div>
                </div>

                <div class="glass p-8 rounded-[2.5rem] text-center space-y-6">
                    <div id="dice-res" class="text-6xl">üé≤</div>
                    <h4 class="text-xl font-black uppercase">Lancer de D√©s</h4>
                    <input id="bet-dice" type="number" value="1" class="w-full bg-black/40 p-4 rounded-2xl text-center font-black outline-none border border-white/5">
                    <button onclick="playDice()" class="w-full bg-mkRed text-white py-4 rounded-xl font-black text-[10px] uppercase">Lancer le d√©</button>
                </div>

                <div class="glass p-8 rounded-[2.5rem] text-center space-y-6">
                    <div class="text-xl font-black uppercase italic">Pierre Feuille Ciseaux</div>
                    <div class="flex justify-center gap-2">
                        <button onclick="playRPS('pierre')" class="w-16 h-16 glass rounded-2xl text-2xl hover:bg-white/10">‚úä</button>
                        <button onclick="playRPS('feuille')" class="w-16 h-16 glass rounded-2xl text-2xl hover:bg-white/10">‚úã</button>
                        <button onclick="playRPS('ciseaux')" class="w-16 h-16 glass rounded-2xl text-2xl hover:bg-white/10">‚úåÔ∏è</button>
                    </div>
                    <input id="bet-rps" type="number" value="1" class="w-full bg-black/40 p-4 rounded-2xl text-center font-black outline-none border border-white/5">
                    <p class="text-[9px] opacity-40 uppercase font-black">Choisissez votre signe et misez</p>
                </div>
            </div>
        </section>

        <section id="section-profile" class="content-view hidden space-y-8 animate-fade">
            <div class="max-w-xl mx-auto space-y-6">
                <div class="glass p-4 rounded-2xl flex gap-3">
                    <input id="search-username" type="text" placeholder="Rechercher un profil par nom..." class="flex-1 bg-transparent px-4 outline-none font-bold text-sm">
                    <button onclick="searchUser()" class="bg-mkBlue text-black px-6 py-3 rounded-xl font-black text-xs uppercase">Rechercher</button>
                </div>

                <div id="profile-card" class="glass p-10 rounded-[3rem] text-center relative overflow-hidden border border-white/10">
                    <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-mkBlue/20 to-transparent"></div>
                    
                    <div class="relative z-10">
                        <img id="p-avatar" src="" class="w-32 h-32 rounded-[2rem] mx-auto border-4 border-mkDark shadow-2xl object-cover">
                        <h2 id="p-username" class="text-4xl font-black mt-6 italic uppercase tracking-tighter">Chargement...</h2>
                        <div class="flex justify-center gap-4 mt-6">
                            <div class="bg-black/40 px-6 py-4 rounded-3xl border border-white/5">
                                <p class="text-[9px] opacity-50 uppercase font-black">Solde Cash</p>
                                <p id="p-cash" class="text-xl font-black text-mkGreen">0.00‚Ç¨</p>
                            </div>
                            <div class="bg-black/40 px-6 py-4 rounded-3xl border border-white/5">
                                <p class="text-[9px] opacity-50 uppercase font-black">Points XP</p>
                                <p id="p-xp" class="text-xl font-black text-mkYellow">0</p>
                            </div>
                        </div>

                        <div id="profile-actions" class="mt-10 pt-10 border-t border-white/5 space-y-4">
                            <div class="text-left space-y-2">
                                <label class="text-[10px] font-black uppercase opacity-40 ml-2">Changer Photo de Profil (URL)</label>
                                <input id="p-pfp-input" type="text" placeholder="https://image.com/votre-photo.jpg" class="w-full bg-black/40 p-4 rounded-2xl text-xs outline-none border border-white/5 focus:border-mkBlue/50">
                                <button onclick="updateProfilePFP()" class="w-full bg-white text-black py-4 rounded-2xl font-black text-xs uppercase">Sauvegarder l'avatar</button>
                            </div>

                            <div class="text-left space-y-2 pt-4">
                                <label class="text-[10px] font-black uppercase opacity-40 ml-2">Code Cadeau / TV</label>
                                <div class="flex gap-2">
                                    <input id="p-code-input" type="text" placeholder="Entrez le code" class="flex-1 bg-black/40 p-4 rounded-2xl text-xs outline-none border border-white/5 font-black uppercase">
                                    <button onclick="redeemCode('p-code-input')" class="bg-mkPurple text-white px-8 rounded-2xl font-black text-xs uppercase">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="section-leaderboard" class="content-view hidden space-y-8 animate-fade">
            <h2 class="text-5xl font-black italic uppercase text-center">Tops <span class="text-mkGreen">Riches</span></h2>
            <div id="leaderboard-container" class="glass rounded-[3rem] overflow-hidden border border-white/10">
                </div>
        </section>

        <section id="section-tv" class="content-view hidden space-y-6 animate-fade">
            <h2 class="text-4xl font-black italic uppercase">Lecteur <span class="text-mkPurple">Cin√©ma VIP</span></h2>
            <div class="bg-black aspect-video rounded-[2.5rem] overflow-hidden border-4 border-mkPurple/30 shadow-2xl relative">
                <iframe id="tv-iframe" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="flex gap-3 overflow-x-auto py-4 no-scrollbar">
                <button onclick="playMovie('https://www.youtube.com/embed/S8_YwFLCh4U')" class="bg-white/5 hover:bg-mkPurple/20 px-6 py-4 rounded-2xl whitespace-nowrap font-bold text-xs transition">ONE PIECE: RED</button>
                <button onclick="playMovie('https://www.youtube.com/embed/1vRzN7p0f8Y')" class="bg-white/5 hover:bg-mkPurple/20 px-6 py-4 rounded-2xl whitespace-nowrap font-bold text-xs transition">NARUTO SHIPPUDEN</button>
                <button onclick="playMovie('https://www.youtube.com/embed/Sx-C5yF2yJk')" class="bg-white/5 hover:bg-mkPurple/20 px-6 py-4 rounded-2xl whitespace-nowrap font-bold text-xs transition">DRAGON BALL SUPER</button>
                <button onclick="playMovie('https://www.youtube.com/embed/5m3O6B6rRz4')" class="bg-white/5 hover:bg-mkPurple/20 px-6 py-4 rounded-2xl whitespace-nowrap font-bold text-xs transition">FILM ACTION EXCLU</button>
            </div>
        </section>

        <section id="section-admin" class="content-view hidden space-y-10 animate-fade">
            <h2 class="text-4xl font-black text-mkAdmin italic uppercase">‚ö° Console Supr√™me</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <h3 class="font-black uppercase text-sm flex items-center gap-2">Tickets Ouverts <span id="ticket-count" class="bg-mkRed text-[10px] px-2 py-0.5 rounded">0</span></h3>
                    <div id="admin-tickets-list" class="space-y-3">
                        </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-black uppercase text-sm">Gestion des Utilisateurs</h3>
                    <div id="admin-users-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2 no-scrollbar">
                        </div>
                </div>
            </div>
        </section>

    </main>

    <aside id="chat-sidebar" class="fixed right-8 top-28 bottom-12 w-[340px] glass rounded-[3rem] hidden xl:flex flex-col overflow-hidden border border-white/5 shadow-2xl">
        <div class="p-6 bg-white/5 border-b border-white/5 flex justify-between items-center">
            <span class="text-[11px] font-black uppercase tracking-widest text-mkBlue italic">Chat Global</span>
            <span id="online-indicator" class="w-2 h-2 bg-mkGreen rounded-full shadow-[0_0_10px_#22c55e]"></span>
        </div>
        
        <div id="chat-messages" class="flex-1 p-6 overflow-y-auto space-y-6 no-scrollbar">
            </div>

        <div class="p-6 border-t border-white/5">
            <div class="bg-black/40 rounded-2xl p-2 flex gap-2 border border-white/10 focus-within:border-mkBlue/50 transition">
                <input id="chat-input" type="text" placeholder="√âcrire un message..." class="bg-transparent outline-none flex-1 px-3 text-xs font-medium">
                <button onclick="sendChatMessage()" class="w-10 h-10 bg-mkBlue text-black rounded-xl flex items-center justify-center hover:scale-105 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <div id="auth-modal" class="fixed inset-0 z-[1000] bg-black/95 hidden flex items-center justify-center p-6">
        <div class="glass w-full max-w-md rounded-[3rem] p-12 text-center relative border-t-8 border-mkBlue">
            <button onclick="closeModal('auth-modal')" class="absolute top-8 right-8 text-white/40 hover:text-white transition">‚úï</button>
            <h3 class="text-3xl font-black italic uppercase">Rejoindre <span class="text-mkBlue">MK</span></h3>
            <p class="text-white/40 font-bold text-[10px] uppercase mt-2 mb-8">Acc√©dez √† votre compte et √† vos fonds</p>
            
            <div class="space-y-3">
                <input id="auth-email" type="email" placeholder="Adresse Email" class="w-full bg-white/5 p-4 rounded-2xl outline-none focus:bg-white/10 transition">
                <input id="auth-username" type="text" placeholder="Pseudo MK" class="w-full bg-white/5 p-4 rounded-2xl outline-none focus:bg-white/10 transition">
                <input id="auth-password" type="password" placeholder="Mot de passe" class="w-full bg-white/5 p-4 rounded-2xl outline-none focus:bg-white/10 transition">
                <button onclick="submitAuth()" class="w-full bg-mkBlue text-black py-4 rounded-2xl font-black text-xs uppercase shadow-xl shadow-mkBlue/20 mt-4">Confirmer l'acc√®s</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION SUPABASE
        const SUPABASE_URL = "https://eeiuxfcgysrarctokuyg.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_0fuup_i-vDgKHozqpz706A_4tGWghxn";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // STATE MANAGER
        let currentUser = null;
        let activeStat = 'cash'; // 'cash' ou 'xp'
        let chatInterval = null;

        // --- CORE FUNCTIONS ---

        function mkNotify(msg, color = 'mkBlue') {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeft = `6px solid var(--${color})`;
            toast.style.backgroundColor = '#000';
            toast.innerHTML = `<span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            document.body.classList.toggle('light', !isDark);
            mkNotify(isDark ? "Mode Sombre activ√©" : "Mode Clair activ√©");
        }

        function showSection(id) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.add('hidden'));
            document.getElementById('section-' + id).classList.remove('hidden');
            
            // Re-sync specific section data
            if(id === 'leaderboard') fetchLeaderboard();
            if(id === 'admin') fetchAdminPanel();
            if(id === 'profile') renderProfileData(currentUser);
        }

        function setActiveStat(type) {
            activeStat = type;
            document.getElementById('btn-stat-cash').className = type === 'cash' ? 'px-4 py-2 rounded-xl text-[11px] font-black bg-mkGreen text-black transition' : 'px-4 py-2 rounded-xl text-[11px] font-black opacity-40 transition';
            document.getElementById('btn-stat-xp').className = type === 'xp' ? 'px-4 py-2 rounded-xl text-[11px] font-black bg-mkYellow text-black transition' : 'px-4 py-2 rounded-xl text-[11px] font-black opacity-40 transition';
            updateTopDisplay();
        }

        // --- AUTH SYSTEM ---

        async function submitAuth() {
            const e = document.getElementById('auth-email').value.trim();
            const u = document.getElementById('auth-username').value.trim();
            const p = document.getElementById('auth-password').value.trim();

            if(!e || !p) return mkNotify("Veuillez remplir les champs", "mkRed");

            // Recherche si l'utilisateur existe
            let { data: profile, error } = await sb.from('profiles').select('*').eq('email', e).maybeSingle();

            if(!profile) {
                // Cr√©ation si nouveau
                const { data, error: insErr } = await sb.from('profiles').insert([{
                    email: e,
                    username: u || "User" + Math.floor(Math.random()*999),
                    password: p,
                    balance: 10,
                    xp: 0,
                    pfp: `https://api.dicebear.com/7.x/pixel-art/svg?seed=${e}`,
                    tv_access: false,
                    banned: false
                }]).select().single();
                if(insErr) return mkNotify("Erreur cr√©ation", "mkRed");
                profile = data;
            } else {
                // V√©rification password (simple pour cet exemple)
                if(profile.password !== p) return mkNotify("Mot de passe incorrect", "mkRed");
            }

            if(profile.banned) return mkNotify("CE COMPTE EST BANNI", "mkRed");

            currentUser = profile;
            localStorage.setItem('mk_session', JSON.stringify(currentUser));
            closeModal('auth-modal');
            setupUserSession();
            mkNotify(`Bienvenue, ${currentUser.username} !`, "mkGreen");
        }

        function setupUserSession() {
            if(!currentUser) return;
            document.getElementById('login-trigger').classList.add('hidden');
            document.getElementById('user-controls').classList.remove('hidden');
            document.getElementById('nav-pfp').src = currentUser.pfp;
            
            updateTopDisplay();

            if(currentUser.username.toLowerCase() === 'admin') {
                document.getElementById('nav-admin').classList.remove('hidden');
            }

            if(currentUser.tv_access) {
                renderTVButton();
            }

            startChatSync();
        }

        function updateTopDisplay() {
            if(!currentUser) return;
            const disp = document.getElementById('top-display-val');
            if(activeStat === 'cash') {
                disp.innerText = currentUser.balance.toFixed(2) + "‚Ç¨";
                disp.className = "font-black text-lg text-mkGreen";
            } else {
                disp.innerText = currentUser.xp + " XP";
                disp.className = "font-black text-lg text-mkYellow";
            }
        }

        // --- CASINO SYSTEM ---

        async function updateBalance(newAmount, xpGain = 5) {
            const { data, error } = await sb.from('profiles').update({ 
                balance: newAmount, 
                xp: currentUser.xp + xpGain 
            }).eq('id', currentUser.id).select().single();
            
            if(!error) {
                currentUser = data;
                updateTopDisplay();
                renderProfileData(currentUser);
            }
        }

        async function playCoin(side) {
            const bet = parseFloat(document.getElementById('bet-coin').value);
            if(bet > currentUser.balance || bet <= 0) return mkNotify("Pas assez de Cash", "mkRed");

            const win = Math.random() > 0.52; // Maison a un l√©ger avantage
            const outcome = win ? side : (side === 'pile' ? 'face' : 'pile');
            
            mkNotify(`Lancement de la pi√®ce... R√©sultat: ${outcome.toUpperCase()}`);
            
            const newBal = win ? currentUser.balance + bet : currentUser.balance - bet;
            await updateBalance(newBal, 10);
            
            mkNotify(win ? "C'EST GAGN√â ! x2" : "PERDU... Retente ta chance", win ? "mkGreen" : "mkRed");
        }

        async function playSlots() {
            const bet = parseFloat(document.getElementById('bet-slots').value);
            if(bet > currentUser.balance || bet <= 0) return mkNotify("Pas assez de Cash", "mkRed");

            const s1 = document.getElementById('slot1');
            const s2 = document.getElementById('slot2');
            const s3 = document.getElementById('slot3');
            
            s1.classList.add('slot-spinning'); s2.classList.add('slot-spinning'); s3.classList.add('slot-spinning');
            
            const symbols = ['üçí', 'üçã', 'üíé', 'üçá', '‚≠ê'];
            
            setTimeout(async () => {
                s1.classList.remove('slot-spinning');
                s2.classList.remove('slot-spinning');
                s3.classList.remove('slot-spinning');
                
                const r1 = symbols[Math.floor(Math.random()*symbols.length)];
                const r2 = symbols[Math.floor(Math.random()*symbols.length)];
                const r3 = symbols[Math.floor(Math.random()*symbols.length)];
                
                s1.innerText = r1; s2.innerText = r2; s3.innerText = r3;
                
                let winMult = 0;
                if(r1 === r2 && r2 === r3) winMult = 10;
                else if(r1 === r2 || r2 === r3 || r1 === r3) winMult = 2;
                
                const profit = bet * winMult;
                const newBal = (currentUser.balance - bet) + profit;
                await updateBalance(newBal, 15);
                
                if(winMult > 0) mkNotify(`JACKPOT x${winMult} ! +${profit}‚Ç¨`, "mkPurple");
                else mkNotify("Aucune correspondance.", "mkRed");
            }, 1000);
        }

        async function playRPS(choice) {
            const bet = parseFloat(document.getElementById('bet-rps').value);
            if(bet > currentUser.balance || bet <= 0) return mkNotify("Solde insuffisant", "mkRed");

            const bot = ['pierre', 'feuille', 'ciseaux'][Math.floor(Math.random()*3)];
            let res = "perdu";
            if(choice === bot) res = "nul";
            else if((choice === 'pierre' && bot === 'ciseaux') || (choice === 'feuille' && bot === 'pierre') || (choice === 'ciseaux' && bot === 'feuille')) res = "gagn√©";
            
            const newBal = res === 'gagn√©' ? currentUser.balance + bet : (res === 'perdu' ? currentUser.balance - bet : currentUser.balance);
            await updateBalance(newBal, 5);
            
            mkNotify(`BOT: ${bot.toUpperCase()} -> ${res.toUpperCase()}`, res === 'gagn√©' ? 'mkGreen' : 'mkRed');
        }

        // --- PROFILE & CODES SYSTEM ---

        async function redeemCode(inputId) {
            const code = document.getElementById(inputId).value.trim().toUpperCase();
            if(!code) return;

            if(code === "LXS-1") {
                const { data } = await sb.from('profiles').update({ balance: currentUser.balance + 10 }).eq('id', currentUser.id).select().single();
                currentUser = data;
                mkNotify("üéÅ Code Cadeau: +10.00‚Ç¨ ajout√©s !", "mkGreen");
            } else if(code === "TVACCESS") {
                const { data } = await sb.from('profiles').update({ tv_access: true }).eq('id', currentUser.id).select().single();
                currentUser = data;
                renderTVButton();
                mkNotify("üì∫ Acc√®s TV d√©bloqu√© √† vie !", "mkPurple");
            } else {
                mkNotify("Code invalide ou expir√©.", "mkRed");
            }
            setupUserSession();
            document.getElementById(inputId).value = "";
        }

        function renderTVButton() {
            const area = document.getElementById('tv-activation-ui');
            if(area) area.innerHTML = `<button onclick="showSection('tv')" class="w-full bg-mkGreen text-black py-4 rounded-2xl font-black text-xs uppercase animate-pulse">Acc√©der √† la TV Films</button>`;
        }

        async function updateProfilePFP() {
            const url = document.getElementById('p-pfp-input').value;
            if(!url.startsWith('http')) return mkNotify("URL invalide", "mkRed");
            
            const { data, error } = await sb.from('profiles').update({ pfp: url }).eq('id', currentUser.id).select().single();
            if(!error) {
                currentUser = data;
                setupUserSession();
                renderProfileData(currentUser);
                mkNotify("Avatar mis √† jour !");
            }
        }

        function renderProfileData(u) {
            if(!u) return;
            document.getElementById('p-avatar').src = u.pfp;
            document.getElementById('p-username').innerText = u.username;
            document.getElementById('p-cash').innerText = u.balance.toFixed(2) + "‚Ç¨";
            document.getElementById('p-xp').innerText = u.xp;
        }

        async function searchUser() {
            const name = document.getElementById('search-username').value.trim();
            const { data, error } = await sb.from('profiles').select('*').eq('username', name).maybeSingle();
            if(data) {
                renderProfileData(data);
                mkNotify(`Profil de ${name} trouv√©`);
            } else {
                mkNotify("Utilisateur introuvable", "mkRed");
            }
        }

        // --- SUPPORT & TICKETS ---

        async function openTicket(type) {
            if(!currentUser) return mkNotify("Connectez-vous d'abord", "mkRed");
            const { error } = await sb.from('tickets').insert([{
                username: currentUser.username,
                type: type,
                status: 'open',
                created_at: new Date()
            }]);
            if(!error) mkNotify("Ticket envoy√© au staff !", "mkGreen");
        }

        // --- ADMIN SYSTEM ---

        async function fetchAdminPanel() {
            // USERS
            const { data: users } = await sb.from('profiles').select('*');
            const list = document.getElementById('admin-users-list');
            list.innerHTML = users.map(u => `
                <div class="glass p-5 rounded-2xl text-[10px] space-y-3">
                    <div class="flex justify-between items-center">
                        <b class="text-xs uppercase">${u.username}</b>
                        <span class="${u.banned ? 'text-mkRed' : 'text-mkGreen'} font-black">${u.banned ? 'BANNI' : 'ACTIF'}</span>
                    </div>
                    <div class="opacity-60 bg-black/20 p-2 rounded">
                        Email: ${u.email} <br> Pass: <span class="text-mkBlue font-bold">${u.password}</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="adminAction('${u.id}', 'cash', 50)" class="bg-mkGreen/20 text-mkGreen p-2 rounded flex-1">+50‚Ç¨</button>
                        <button onclick="adminAction('${u.id}', 'cash', -50)" class="bg-mkRed/20 text-mkRed p-2 rounded flex-1">-50‚Ç¨</button>
                        <button onclick="adminAction('${u.id}', 'xp', 100)" class="bg-mkYellow/20 text-mkYellow p-2 rounded flex-1">+100XP</button>
                        <button onclick="adminAction('${u.id}', 'ban', ${!u.banned})" class="bg-white/10 p-2 rounded flex-1">${u.banned ? 'UNBAN' : 'BAN'}</button>
                    </div>
                </div>
            `).join('');

            // TICKETS
            const { data: tix } = await sb.from('tickets').select('*').eq('status', 'open');
            document.getElementById('ticket-count').innerText = tix.length;
            document.getElementById('admin-tickets-list').innerHTML = tix.map(t => `
                <div class="bg-mkRed/10 border border-mkRed/30 p-4 rounded-2xl flex justify-between items-center">
                    <div>
                        <b class="text-[11px] uppercase text-mkRed">${t.type}</b>
                        <p class="text-[9px] opacity-60">Par: ${t.username}</p>
                    </div>
                    <button onclick="closeTicket('${t.id}')" class="bg-mkRed text-white px-4 py-2 rounded-xl text-[10px] font-black">R√âPONDRE/FERMER</button>
                </div>
            `).join('');
        }

        async function adminAction(userId, action, value) {
            const { data: u } = await sb.from('profiles').select('*').eq('id', userId).single();
            let update = {};
            if(action === 'cash') update = { balance: u.balance + value };
            if(action === 'xp') update = { xp: u.xp + value };
            if(action === 'ban') update = { banned: value };

            await sb.from('profiles').update(update).eq('id', userId);
            fetchAdminPanel();
            mkNotify("Action Admin effectu√©e");
        }

        async function closeTicket(id) {
            await sb.from('tickets').update({ status: 'closed' }).eq('id', id);
            fetchAdminPanel();
        }

        // --- CHAT SYSTEM ---

        async function startChatSync() {
            if(chatInterval) clearInterval(chatInterval);
            fetchChatMessages();
            chatInterval = setInterval(fetchChatMessages, 3000);
        }

        async function fetchChatMessages() {
            const { data } = await sb.from('messages').select('*').order('created_at', { ascending: false }).limit(20);
            if(!data) return;

            const box = document.getElementById('chat-messages');
            const html = data.reverse().map(m => {
                const lvl = m.level || 0;
                let tagColor = 'mkBlue';
                if(lvl > 10) tagColor = 'mkPurple';
                if(m.username.toLowerCase() === 'admin') tagColor = 'mkAdmin';

                return `
                <div class="flex gap-3 items-start group">
                    <img src="${m.pfp || 'https://api.dicebear.com/7.x/pixel-art/svg?seed='+m.username}" class="w-8 h-8 rounded-lg">
                    <div class="flex-1">
                        <div class="flex items-center">
                            <span class="chat-tag bg-${tagColor} text-white">LVL ${lvl}</span>
                            <b class="text-[10px] uppercase tracking-tighter">${m.username}</b>
                        </div>
                        <p class="text-[11px] opacity-80 mt-1 leading-relaxed">${m.content}</p>
                    </div>
                </div>`;
            }).join('');
            
            const shouldScroll = box.scrollTop + box.offsetHeight >= box.scrollHeight - 50;
            box.innerHTML = html;
            if(shouldScroll) box.scrollTop = box.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!currentUser || !msg) return;

            await sb.from('messages').insert([{
                username: currentUser.username,
                content: msg,
                pfp: currentUser.pfp,
                level: Math.floor(currentUser.xp / 100),
                created_at: new Date()
            }]);

            input.value = "";
            fetchChatMessages();
        }

        // --- UI UTILS ---

        async function fetchLeaderboard() {
            const { data } = await sb.from('profiles').select('*').order('balance', { ascending: false }).limit(10);
            const cont = document.getElementById('leaderboard-container');
            cont.innerHTML = data.map((u, i) => `
                <div class="flex justify-between items-center p-6 border-b border-white/5 hover:bg-white/5 transition">
                    <div class="flex items-center gap-6">
                        <span class="text-2xl font-black italic opacity-20 w-8">#${i+1}</span>
                        <img src="${u.pfp}" class="w-10 h-10 rounded-xl">
                        <b class="uppercase italic text-sm">${u.username}</b>
                    </div>
                    <div class="text-right">
                        <p class="text-mkGreen font-black">${u.balance.toFixed(2)}‚Ç¨</p>
                        <p class="text-[9px] opacity-40 font-bold uppercase">${u.xp} XP</p>
                    </div>
                </div>
            `).join('');
        }

        function playMovie(url) {
            document.getElementById('tv-iframe').src = url;
            mkNotify("Chargement du flux vid√©o...", "mkPurple");
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }

        // --- BOOTSTRAP ---
        window.onload = () => {
            const session = localStorage.getItem('mk_session');
            if(session) {
                currentUser = JSON.parse(session);
                // Refresh data from DB
                sb.from('profiles').select('*').eq('id', currentUser.id).single().then(({data}) => {
                    if(data) {
                        currentUser = data;
                        setupUserSession();
                    }
                });
            }
            fetchChatMessages();
            setInterval(fetchChatMessages, 5000);
        };
    </script>
</body>
</html>
