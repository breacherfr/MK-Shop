<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK SHOP - SUPREME V71</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        mkBlue: '#00d2ff', mkRed: '#ff4b5c', mkPurple: '#a363ff',
                        mkYellow: '#fbbf24', mkGreen: '#22c55e', mkAdmin: '#ff00ff',
                        mkDark: '#050505', mkCard: '#0d0d0f'
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '3.5rem', '6xl': '5rem' }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #030303; 
            color: #fff; 
            overflow-x: hidden; 
            scroll-behavior: smooth;
        }

        /* EFFET GLASSMORPHISM V65 */
        .glass { 
            backdrop-filter: blur(25px); 
            background: rgba(13, 13, 15, 0.95); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        .light { background-color: #f0f2f5; color: #1a1a1a; }
        .light .glass { background: rgba(245, 245, 250, 0.9); }

        /* ANIMATIONS DE TRANSITION */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-view { animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #00d2ff; border-radius: 10px; }

        /* TOAST NOTIF */
        .toast {
            position: fixed; top: 30px; right: 30px; z-index: 10000;
            padding: 18px 35px; border-radius: 20px;
            background: #000; border-left: 6px solid #00d2ff;
            font-weight: 900; font-size: 12px; text-transform: uppercase;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* CHAT SYSTEM REWORK */
        #mini-chat {
            position: fixed; bottom: 30px; right: 30px;
            width: 380px; height: 580px; z-index: 5000;
            display: none; flex-direction: column;
            border-radius: 3.5rem; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 40px 80px rgba(0,0,0,0.7);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .slot-machine {
            background: linear-gradient(180deg, #111, #000);
            border: 4px solid #1a1a1a;
            border-radius: 30px;
        }
    </style>
</head>
<body class="dark">

    <nav class="glass sticky top-0 z-[1000] px-10 py-7 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-12">
            <div class="flex items-center gap-4 cursor-pointer group" onclick="showSection('shop')">
                <div class="w-14 h-14 bg-mkBlue rounded-2xl flex items-center justify-center font-black text-black text-xl shadow-lg group-hover:rotate-12 transition">MK</div>
                <div>
                    <h1 class="font-black text-2xl italic tracking-tighter leading-none">MK SHOP</h1>
                    <span class="text-[8px] font-bold text-mkBlue uppercase tracking-widest opacity-60">Version 71.0 Supreme</span>
                </div>
            </div>
            
            <div class="hidden lg:flex gap-8">
                <button onclick="showSection('shop')" class="text-[10px] font-black uppercase tracking-[0.2em] hover:text-mkBlue transition">Market</button>
                <button onclick="showSection('games')" class="text-[10px] font-black uppercase tracking-[0.2em] hover:text-mkBlue transition">Jeux</button>
                <button onclick="showSection('leaderboard')" class="text-[10px] font-black uppercase tracking-[0.2em] hover:text-mkBlue transition">Top 10</button>
                <button onclick="showSection('profile')" class="text-[10px] font-black uppercase tracking-[0.2em] hover:text-mkBlue transition">Profil</button>
                <button id="nav-admin" onclick="showSection('admin')" class="hidden text-[10px] font-black uppercase text-mkAdmin border border-mkAdmin/30 px-3 py-1 rounded-lg">Console</button>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <div class="flex bg-black/40 rounded-xl p-1 border border-white/10">
                <button id="m-cash" onclick="setMode('cash')" class="px-5 py-2 rounded-lg text-[9px] font-black bg-mkGreen text-black transition shadow-lg">CASH</button>
                <button id="m-xp" onclick="setMode('xp')" class="px-5 py-2 rounded-lg text-[9px] font-black opacity-30 transition text-white">XP</button>
            </div>
            
            <div class="bg-black/30 px-6 py-2.5 rounded-xl border border-white/5 min-w-[130px] text-center">
                <span id="val-display" class="font-black text-mkGreen text-lg tracking-tighter">0.00‚Ç¨</span>
            </div>

            <div id="auth-zone">
                <button onclick="openModal('modal-auth')" class="bg-mkBlue text-black px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg hover:bg-white transition">Connexion</button>
            </div>

            <div id="user-zone" class="hidden flex items-center gap-4">
                <img id="u-pfp" src="" class="w-12 h-12 rounded-2xl border-2 border-mkBlue object-cover">
                <button onclick="logout()" class="w-10 h-10 glass rounded-xl text-mkRed font-black">‚úï</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-8 py-14 lg:pr-[420px]">

        <section id="s-shop" class="animate-view space-y-12">
            <h2 class="text-6xl font-black italic uppercase tracking-tighter leading-none">Le <span class="text-mkBlue">March√©</span></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glass p-10 rounded-5xl border-t-8 border-mkBlue hover:scale-[1.02] transition">
                    <span class="text-4xl">üéÆ</span>
                    <h3 class="text-2xl font-black uppercase mt-6 italic">Comptes Roblox</h3>
                    <p class="text-[11px] opacity-40 mt-3 font-medium leading-relaxed">Acc√®s complet (Mail + MDP) sur des comptes rares, items limiteds et progression avanc√©e sur Blox Fruits/PS99.</p>
                    <div class="mt-8 flex justify-between items-center">
                        <span class="text-xl font-black">D√®s 10.00‚Ç¨</span>
                        <button onclick="openTicket('Achat Roblox')" class="bg-white text-black px-6 py-3 rounded-xl font-black text-[10px] uppercase">Commander</button>
                    </div>
                </div>

                <div class="glass p-10 rounded-5xl border-t-8 border-mkPurple hover:scale-[1.02] transition">
                    <span class="text-4xl">‚ö°</span>
                    <h3 class="text-2xl font-black uppercase mt-6 italic">Scripts & Exploits</h3>
                    <p class="text-[11px] opacity-40 mt-3 font-medium leading-relaxed">Executeurs premium et menus priv√©s pour les jeux du moment. Ind√©tectables et mis √† jour 24/7.</p>
                    <div class="mt-8 flex justify-between items-center">
                        <span class="text-xl font-black text-mkPurple">Licences Auto</span>
                        <button onclick="openTicket('Achat Cheat')" class="bg-mkPurple text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase">Voir Menu</button>
                    </div>
                </div>

                <div class="glass p-10 rounded-5xl border-t-8 border-mkYellow">
                    <span class="text-4xl">üçø</span>
                    <h3 class="text-2xl font-black uppercase mt-6 italic">Abonnements</h3>
                    <p class="text-[11px] opacity-40 mt-3 font-medium leading-relaxed">Netflix, Disney+, Spotify Premium √† prix cass√©s. M√©thodes certifi√©es MK.</p>
                    <button onclick="openTicket('Achat Premium')" class="w-full mt-8 bg-mkYellow text-black py-4 rounded-xl font-black text-[10px] uppercase">Consulter les tarifs</button>
                </div>

                <div id="tv-card" class="glass p-10 rounded-5xl border-t-8 border-mkAdmin relative overflow-hidden">
                    <div class="absolute -right-5 -top-5 w-24 h-24 bg-mkAdmin/10 rounded-full blur-3xl"></div>
                    <h3 class="text-2xl font-black uppercase italic text-mkAdmin">MK Cinema VIP</h3>
                    <p class="text-[10px] font-bold opacity-30 uppercase mt-2 mb-6 tracking-widest">Films & S√©ries Illimit√©s</p>
                    <div id="tv-action" class="space-y-4">
                        <input id="tv-code" type="text" placeholder="CODE D'ACC√àS" class="w-full bg-black/40 p-4 rounded-xl text-[10px] font-black uppercase outline-none border border-white/5">
                        <button onclick="unlockTV()" class="w-full bg-mkAdmin text-white py-4 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-mkAdmin/20">D√©bloquer la TV</button>
                    </div>
                </div>
            </div>

            <div class="glass p-12 rounded-[4rem] border-2 border-mkRed flex flex-col md:flex-row justify-between items-center gap-6">
                <div>
                    <h3 class="text-4xl font-black text-mkRed italic uppercase leading-none">Besoin d'aide ?</h3>
                    <p class="text-[10px] font-bold opacity-30 uppercase mt-2">Tickets ouverts 24h/24 pour vos achats ou retraits</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="openTicket('Support')" class="bg-white/5 border border-white/10 px-8 py-4 rounded-xl font-black text-[10px] uppercase">Ouvrir Ticket</button>
                    <button onclick="openTicket('CASHOUT')" class="bg-mkRed text-white px-8 py-4 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-mkRed/30">Retirer Cash</button>
                </div>
            </div>
        </section>

        <section id="s-games" class="hidden animate-view space-y-12">
            <h2 class="text-6xl font-black italic uppercase tracking-tighter leading-none">MK <span class="text-mkRed">Casino</span></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glass p-12 rounded-5xl text-center">
                    <div id="coin-res" class="text-8xl mb-10 transition-transform duration-500">ü™ô</div>
                    <div class="flex flex-col items-center gap-6">
                        <input id="bet-coin" type="number" value="10" class="bg-black/50 p-4 rounded-xl w-32 text-center font-black text-xl outline-none border border-white/10">
                        <div class="flex gap-4 w-full">
                            <button onclick="playGame('coin', 'pile')" class="flex-1 bg-mkBlue text-black py-4 rounded-xl font-black text-[10px] uppercase">Pile</button>
                            <button onclick="playGame('coin', 'face')" class="flex-1 bg-white text-black py-4 rounded-xl font-black text-[10px] uppercase">Face</button>
                        </div>
                    </div>
                </div>

                <div class="glass p-12 rounded-5xl text-center border-t-4 border-mkPurple">
                    <div class="slot-machine flex justify-center gap-4 text-6xl py-10 mb-8 border border-white/10">
                        <span id="sl1">üçí</span><span id="sl2">üçí</span><span id="sl3">üçí</span>
                    </div>
                    <input id="bet-slots" type="number" value="10" class="bg-black/50 p-4 rounded-xl w-32 text-center font-black text-xl mb-6 outline-none">
                    <button onclick="playGame('slots')" class="w-full bg-mkPurple text-white py-4 rounded-xl font-black text-[10px] uppercase shadow-lg">Tirer le levier (Win x12)</button>
                </div>

                <div class="glass p-12 rounded-5xl text-center">
                    <div id="dice-res" class="text-8xl mb-10 text-mkYellow">üé≤</div>
                    <input id="bet-dice" type="number" value="10" class="bg-black/50 p-4 rounded-xl w-32 text-center font-black text-xl mb-6 outline-none">
                    <button onclick="playGame('dice')" class="w-full bg-mkYellow text-black py-4 rounded-xl font-black text-[10px] uppercase">Lancer (4+ pour gagner)</button>
                </div>

                <div class="glass p-12 rounded-5xl text-center">
                    <h3 class="text-2xl font-black uppercase mb-8 italic">Chifoumi Royal</h3>
                    <div class="flex justify-center gap-4 mb-8">
                        <button onclick="playGame('rps', 'pierre')" class="w-16 h-16 glass rounded-2xl text-2xl hover:bg-mkBlue transition">‚úä</button>
                        <button onclick="playGame('rps', 'feuille')" class="w-16 h-16 glass rounded-2xl text-2xl hover:bg-mkBlue transition">‚úã</button>
                        <button onclick="playGame('rps', 'ciseaux')" class="w-16 h-16 glass rounded-2xl text-2xl hover:bg-mkBlue transition">‚úåÔ∏è</button>
                    </div>
                    <input id="bet-rps" type="number" value="10" class="bg-black/50 p-4 rounded-xl w-32 text-center font-black text-xl outline-none">
                    <p class="text-[9px] opacity-30 mt-4 font-bold uppercase tracking-widest italic">Gain x2.5 en cas de victoire</p>
                </div>
            </div>
        </section>

        <section id="s-profile" class="hidden animate-view max-w-2xl mx-auto space-y-10">
            <div class="glass p-5 rounded-3xl flex gap-4">
                <input id="search-name" type="text" placeholder="Rechercher un membre..." class="flex-1 bg-transparent px-4 font-bold outline-none uppercase text-white text-xs">
                <button onclick="findMember()" class="bg-mkBlue text-black px-6 py-3 rounded-xl font-black text-[9px] uppercase">Chercher</button>
            </div>

            <div id="p-card" class="glass p-16 rounded-[5rem] text-center border-b-[15px] border-mkBlue">
                <img id="p-avatar" src="" class="w-40 h-40 rounded-[3rem] mx-auto object-cover border-8 border-mkDark shadow-2xl mb-8">
                <h3 id="p-username" class="text-4xl font-black italic uppercase tracking-tighter">Membre MK</h3>
                
                <div class="grid grid-cols-2 gap-6 mt-10">
                    <div class="bg-black/40 p-8 rounded-[2.5rem] border border-white/5">
                        <p class="text-[9px] opacity-30 font-black uppercase mb-1">Balance</p>
                        <p id="p-val-cash" class="text-2xl font-black text-mkGreen">0.00‚Ç¨</p>
                    </div>
                    <div class="bg-black/40 p-8 rounded-[2.5rem] border border-white/5">
                        <p class="text-[9px] opacity-30 font-black uppercase mb-1">XP total</p>
                        <p id="p-val-xp" class="text-2xl font-black text-mkYellow">0 XP</p>
                    </div>
                </div>

                <div id="p-controls" class="mt-10 pt-10 border-t border-white/5 space-y-6 text-left hidden">
                    <div class="flex flex-col gap-3">
                        <label class="text-[9px] font-black uppercase opacity-40 ml-2">Lien image profil</label>
                        <div class="flex gap-3">
                            <input id="new-pfp-url" type="text" class="flex-1 bg-black/50 p-4 rounded-xl text-[10px] outline-none border border-white/10 text-white">
                            <button onclick="updatePfp()" class="bg-white text-black px-6 rounded-xl font-black text-[10px] uppercase">OK</button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3">
                        <label class="text-[9px] font-black uppercase opacity-40 ml-2">Code Promo</label>
                        <div class="flex gap-3">
                            <input id="promo-code" type="text" class="flex-1 bg-black/50 p-4 rounded-xl text-[10px] font-black uppercase outline-none border border-white/10 text-white">
                            <button onclick="usePromo()" class="bg-mkPurple text-white px-6 rounded-xl font-black text-[10px] uppercase">Activer</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="s-leaderboard" class="hidden animate-view space-y-10">
            <h2 class="text-5xl font-black text-center italic uppercase">Top <span class="text-mkGreen">Fortune</span></h2>
            <div id="leader-container" class="glass rounded-[3.5rem] overflow-hidden border border-white/5 shadow-2xl">
                </div>
        </section>

        <section id="s-admin" class="hidden animate-view space-y-12">
            <h2 class="text-5xl font-black text-mkAdmin italic uppercase tracking-tighter">Console Admin</h2>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
                <div class="space-y-6">
                    <h3 class="text-xs font-black uppercase text-mkRed tracking-widest">Tickets Ouverts</h3>
                    <div id="adm-tickets" class="space-y-4"></div>
                </div>
                <div class="space-y-6">
                    <h3 class="text-xs font-black uppercase text-mkBlue tracking-widest">Membres Shop</h3>
                    <div id="adm-users" class="space-y-4 max-h-[600px] overflow-y-auto no-scrollbar pr-2"></div>
                </div>
            </div>
        </section>

    </main>

    <button onclick="toggleChat()" class="fixed bottom-10 right-10 w-24 h-24 bg-mkBlue rounded-3xl shadow-2xl flex items-center justify-center text-4xl z-[6000] hover:scale-110 active:scale-95 transition-all">üí¨</button>
    
    <div id="mini-chat" class="glass">
        <div class="p-8 bg-white/5 border-b border-white/5 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-3 h-3 bg-mkGreen rounded-full animate-pulse"></div>
                <span class="text-[12px] font-black uppercase tracking-widest">Chat Global</span>
            </div>
            <button onclick="toggleChat()" class="text-white opacity-20 hover:opacity-100 transition">‚úï</button>
        </div>
        
        <div id="chat-flow" class="flex-1 p-8 overflow-y-auto space-y-6 no-scrollbar scroll-smooth">
            </div>
        
        <div class="p-6 border-t border-white/5 bg-mkDark">
            <div class="bg-black/50 rounded-2xl p-2 flex gap-3 border border-white/10">
                <input id="chat-input" type="text" placeholder="√âcrire ici..." class="bg-transparent flex-1 outline-none px-4 text-[11px] font-bold text-white">
                <button onclick="sendChatMessage()" class="w-12 h-12 bg-mkBlue text-black rounded-xl font-black text-xl shadow-lg">></button>
            </div>
        </div>
    </div>

    <div id="modal-auth" class="fixed inset-0 z-[9999] bg-black/90 flex items-center justify-center p-6 hidden">
        <div class="glass w-full max-w-md rounded-[4rem] p-12 text-center border-t-8 border-mkBlue">
            <h3 class="text-4xl font-black italic uppercase leading-none mb-2">MK <span class="text-mkBlue">Auth</span></h3>
            <p class="text-[10px] font-bold opacity-30 uppercase tracking-[0.3em] mb-10">Identifiez-vous pour commander</p>
            
            <div class="space-y-4">
                <input id="in-user" type="text" placeholder="PSEUDONYME (UNIQUE)" class="w-full bg-black/50 p-5 rounded-2xl outline-none text-[11px] font-black border border-white/10 focus:border-mkBlue transition text-white uppercase tracking-widest">
                <input id="in-email" type="email" placeholder="EMAIL (FACULTATIF)" class="w-full bg-black/50 p-5 rounded-2xl outline-none text-[11px] font-black border border-white/10 focus:border-mkBlue transition text-white uppercase tracking-widest">
                <input id="in-pass" type="password" placeholder="MOT DE PASSE" class="w-full bg-black/50 p-5 rounded-2xl outline-none text-[11px] font-black border border-white/10 focus:border-mkBlue transition text-white uppercase tracking-widest">
                
                <button onclick="processAuth()" class="w-full bg-mkBlue text-black py-5 rounded-2xl font-black text-[11px] uppercase mt-4 shadow-xl shadow-mkBlue/20">Valider</button>
                <button onclick="closeModal('modal-auth')" class="text-[9px] font-black opacity-30 uppercase mt-6 block mx-auto">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://eeiuxfcgysrarctokuyg.supabase.co";
        const SB_KEY = "sb_publishable_0fuup_i-vDgKHozqpz706A_4tGWghxn";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let user = null;
        let currentMode = 'cash';
        let chatLoop = null;
        let lastMsgCount = 0;

        function toast(m, c='mkBlue') {
            const el = document.createElement('div');
            el.className = 'toast animate-view';
            el.style.borderLeftColor = `var(--${c})`;
            el.innerText = m;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        // --- AUTH SYSTEM (EMAIL OPTIONAL) ---
        async function processAuth() {
            const u = document.getElementById('in-user').value.trim();
            const e = document.getElementById('in-email').value.trim();
            const p = document.getElementById('in-pass').value.trim();
            
            if(!u || !p) return toast("Pseudo et Password requis", "mkRed");

            // On cherche d'abord par le pseudo (plus fiable si mail facultatif)
            let { data: prof, error } = await sb.from('profiles').select('*').eq('username', u).maybeSingle();

            if(!prof) {
                // Cr√©ation nouveau compte
                const { data, error: insErr } = await sb.from('profiles').insert([{
                    username: u, 
                    email: e || `${u}@mkshop.private`, // Mail fictif si non rempli
                    password: p, 
                    balance: 10, 
                    xp: 0,
                    pfp: `https://api.dicebear.com/7.x/pixel-art/svg?seed=${u}`,
                    tv_access: false,
                    banned: false
                }]).select().single();
                
                if(insErr) return toast("Erreur Serveur", "mkRed");
                prof = data;
                toast("Compte cr√©√© ! +10‚Ç¨ offerts", "mkGreen");
            } else {
                if(prof.password !== p) return toast("Mot de passe incorrect", "mkRed");
                if(prof.banned) return toast("COMPTE BANNI", "mkRed");
            }

            user = prof;
            localStorage.setItem('mk_session_v71', JSON.stringify(user));
            closeModal('modal-auth');
            initApp();
        }

        function initApp() {
            if(!user) return;
            document.getElementById('auth-zone').classList.add('hidden');
            document.getElementById('user-zone').classList.remove('hidden');
            document.getElementById('u-pfp').src = user.pfp;
            if(user.username.toLowerCase() === 'admin') document.getElementById('nav-admin').classList.remove('hidden');
            syncDisplay();
            if(!chatLoop) {
                loadChat();
                chatLoop = setInterval(loadChat, 3000);
            }
        }

        function syncDisplay() {
            if(!user) return;
            const el = document.getElementById('val-display');
            if(currentMode === 'cash') {
                el.innerText = user.balance.toFixed(2) + "‚Ç¨";
                el.className = "font-black text-mkGreen text-lg tracking-tighter";
            } else {
                el.innerText = user.xp + " XP";
                el.className = "font-black text-mkYellow text-lg tracking-tighter";
            }
        }

        async function updateStats(nb, nx=15) {
            const { data } = await sb.from('profiles').update({ balance: nb, xp: user.xp + nx }).eq('id', user.id).select().single();
            if(data) { user = data; syncDisplay(); }
        }

        // --- CASINO ACTIONS ---
        async function playGame(type, side) {
            if(!user) return toast("Connectez-vous !", "mkRed");
            const betInput = document.getElementById('bet-'+type);
            const bet = parseFloat(betInput.value);
            if(bet > user.balance || bet <= 0) return toast("Balance insuffisante", "mkRed");

            if(type === 'coin') {
                const win = Math.random() > 0.52; // 48% Winrate
                document.getElementById('coin-res').innerText = win ? (side === 'pile' ? 'ü™ô' : 'üü°') : (side === 'pile' ? 'üü°' : 'ü™ô');
                await updateStats(win ? user.balance + bet : user.balance - bet, 20);
                toast(win ? "GAGN√â !" : "PERDU", win ? 'mkGreen' : 'mkRed');
            }
            if(type === 'slots') {
                const s = ['üíé','üçí','üçã','‚≠ê','üçá'];
                const r = [s[Math.floor(Math.random()*5)], s[Math.floor(Math.random()*5)], s[Math.floor(Math.random()*5)]];
                document.getElementById('sl1').innerText = r[0]; document.getElementById('sl2').innerText = r[1]; document.getElementById('sl3').innerText = r[2];
                let m = 0;
                if(r[0]===r[1] && r[1]===r[2]) m = 12; else if(r[0]===r[1] || r[1]===r[2] || r[0]===r[2]) m = 2;
                await updateStats((user.balance - bet) + (bet * m), 35);
                toast(m > 0 ? "JACKPOT x"+m : "PERDU", m > 0 ? 'mkPurple' : 'mkRed');
            }
            if(type === 'dice') {
                const d = Math.floor(Math.random()*6)+1;
                const faces = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
                document.getElementById('dice-res').innerText = faces[d-1];
                const win = d >= 4;
                await updateStats(win ? user.balance + (bet * 0.95) : user.balance - bet, 15);
                toast(win ? "BIEN JOU√â" : "PERDU", win ? 'mkGreen' : 'mkRed');
            }
            if(type === 'rps') {
                const opt = ['pierre', 'feuille', 'ciseaux'];
                const bot = opt[Math.floor(Math.random()*3)];
                if(side === bot) toast("√âGALIT√â VS "+bot.toUpperCase(), "mkYellow");
                else if((side==='pierre' && bot==='ciseaux') || (side==='feuille' && bot==='pierre') || (side==='ciseaux' && bot==='feuille')) {
                    await updateStats(user.balance + (bet*1.5), 30); toast("WIN VS "+bot.toUpperCase(), "mkGreen");
                } else { await updateStats(user.balance - bet, 10); toast("PERDU VS "+bot.toUpperCase(), "mkRed"); }
            }
        }

        // --- CHAT REWORK (NO FLICKER) ---
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!user || !msg) return;
            input.value = "";
            const { error } = await sb.from('messages').insert([{
                username: user.username, content: msg, pfp: user.pfp, level: Math.floor(user.xp/150)
            }]);
            if(!error) loadChat();
        }

        async function loadChat() {
            const { data } = await sb.from('messages').select('*').order('created_at', { ascending: false }).limit(30);
            if(!data) return;
            if(data.length === lastMsgCount) return; // Arret si pas de nouveau message
            lastMsgCount = data.length;

            document.getElementById('chat-flow').innerHTML = data.reverse().map(m => `
                <div class="flex gap-4 items-start animate-view">
                    <img src="${m.pfp}" class="w-10 h-10 rounded-xl object-cover border border-white/5 shadow-lg">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[6px] font-black bg-mkBlue text-black px-1.5 py-0.5 rounded uppercase">LVL ${m.level || 0}</span>
                            <b class="text-[10px] uppercase tracking-tighter text-white/90">${m.username}</b>
                        </div>
                        <div class="bg-white/5 p-3 rounded-2xl rounded-tl-none border border-white/5">
                            <p class="text-[11px] text-white/70 font-medium">${m.content}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            const flow = document.getElementById('chat-flow'); flow.scrollTop = flow.scrollHeight;
        }

        // --- PROFILE & SOCIAL ---
        function renderProfile(u) {
            if(!u) return;
            document.getElementById('p-avatar').src = u.pfp;
            document.getElementById('p-username').innerText = u.username;
            document.getElementById('p-val-cash').innerText = u.balance.toFixed(2) + "‚Ç¨";
            document.getElementById('p-val-xp').innerText = u.xp + " XP";
            document.getElementById('p-controls').classList.toggle('hidden', u.id !== user.id);
        }

        async function findMember() {
            const n = document.getElementById('search-name').value.trim();
            const { data } = await sb.from('profiles').select('*').eq('username', n).maybeSingle();
            if(data) renderProfile(data); else toast("Introuvable", "mkRed");
        }

        async function loadLeaderboard() {
            const { data } = await sb.from('profiles').select('*').order('balance', { ascending: false }).limit(10);
            document.getElementById('leader-container').innerHTML = data.map((u, i) => `
                <div class="flex justify-between items-center p-8 border-b border-white/5 hover:bg-white/5 transition">
                    <div class="flex items-center gap-6">
                        <span class="text-2xl font-black italic ${i < 3 ? 'text-mkBlue' : 'opacity-20'}">#${i+1}</span>
                        <img src="${u.pfp}" class="w-14 h-14 rounded-2xl shadow-lg border border-white/5">
                        <b class="text-sm uppercase font-black">${u.username}</b>
                    </div>
                    <span class="text-mkGreen font-black text-xl">${u.balance.toFixed(2)}‚Ç¨</span>
                </div>
            `).join('');
        }

        // --- ADMIN PANEL ---
        async function loadAdminPanel() {
            const { data: tk } = await sb.from('tickets').select('*').eq('status', 'open');
            const { data: us } = await sb.from('profiles').select('*').order('balance', { ascending: false });
            
            document.getElementById('adm-tickets').innerHTML = tk.map(t => `
                <div class="glass p-5 rounded-2xl flex justify-between items-center border-l-4 border-mkRed">
                    <span class="text-[10px] font-black uppercase">${t.type} de ${t.username}</span>
                    <button onclick="closeTicket('${t.id}')" class="bg-mkRed text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase">Clore</button>
                </div>
            `).join('');

            document.getElementById('adm-users').innerHTML = us.map(m => `
                <div class="glass p-5 rounded-2xl flex justify-between items-center">
                    <div class="text-[10px] font-black uppercase">${m.username}<br><span class="text-mkGreen text-[12px]">${m.balance.toFixed(2)}‚Ç¨</span></div>
                    <div class="flex gap-2">
                        <button onclick="adminMod('${m.id}', 10)" class="bg-mkGreen/20 text-mkGreen px-3 py-1 rounded-lg text-[10px]">+10</button>
                        <button onclick="adminMod('${m.id}', -10)" class="bg-mkRed/20 text-mkRed px-3 py-1 rounded-lg text-[10px]">-10</button>
                        <button onclick="adminBan('${m.id}', ${!m.banned})" class="bg-white text-black px-3 py-1 rounded-lg text-[10px]">${m.banned ? 'D√âBAN' : 'BAN'}</button>
                    </div>
                </div>
            `).join('');
        }

        async function adminMod(id, val) {
            const { data } = await sb.from('profiles').select('balance').eq('id', id).single();
            await sb.from('profiles').update({ balance: data.balance + val }).eq('id', id);
            loadAdminPanel();
        }

        async function adminBan(id, s) {
            await sb.from('profiles').update({ banned: s }).eq('id', id);
            loadAdminPanel();
        }

        // --- UI HELPERS ---
        function showSection(id) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById('s-' + id).classList.remove('hidden');
            if(id === 'leaderboard') loadLeaderboard();
            if(id === 'admin') loadAdminPanel();
            if(id === 'profile') renderProfile(user);
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('m-cash').className = m === 'cash' ? 'px-5 py-2 rounded-lg text-[9px] font-black bg-mkGreen text-black transition shadow-lg' : 'px-5 py-2 rounded-lg text-[9px] font-black opacity-30 transition text-white';
            document.getElementById('m-xp').className = m === 'xp' ? 'px-5 py-2 rounded-lg text-[9px] font-black bg-mkYellow text-black transition shadow-lg' : 'px-5 py-2 rounded-lg text-[9px] font-black opacity-30 transition text-white';
            syncDisplay();
        }

        function toggleChat() {
            const c = document.getElementById('mini-chat');
            c.style.display = c.style.display === 'flex' ? 'none' : 'flex';
        }

        async function openTicket(type) {
            if(!user) return toast("Connectez-vous", "mkRed");
            await sb.from('tickets').insert([{ username: user.username, type: type, status: 'open' }]);
            toast("Ticket ouvert !", "mkGreen");
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { localStorage.removeItem('mk_session_v71'); location.reload(); }

        window.onload = () => {
            const saved = localStorage.getItem('mk_session_v71');
            if(saved) { user = JSON.parse(saved); initApp(); }
        };
    </script>
</body>
</html>
