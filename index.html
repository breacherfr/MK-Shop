<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK SHOP - V66 PLATINUM EDITION</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        mkBlue: '#00d2ff', mkRed: '#ff4b5c', mkPurple: '#a363ff',
                        mkYellow: '#fbbf24', mkGreen: '#22c55e', mkAdmin: '#ff00ff',
                        mkDark: '#050505', mkLight: '#f3f4f6'
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '3rem' }
                }
            }
        }
    </script>

    <style>
        /* BASE STYLE & SCROLLBAR */
        body { font-family: 'Montserrat', sans-serif; transition: 0.4s; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: #00d2ff; border-radius: 10px; }
        
        /* EFFETS GLASSMORPHISM */
        .glass { backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .dark .glass { background: rgba(10, 10, 15, 0.95); }
        .light .glass { background: rgba(255, 255, 255, 0.9); border-color: rgba(0, 0, 0, 0.05); }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        
        .toast { position: fixed; top: 30px; right: 30px; z-index: 9999; padding: 20px 30px; border-radius: 20px; font-weight: 900; animation: slideIn 0.3s ease-out; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* COMPOSANTS CHAT */
        .chat-msg { animation: fadeIn 0.3s ease-out; }
        .badge-admin { background: linear-gradient(45deg, #ff00ff, #ff4b5c); color: white; padding: 2px 8px; border-radius: 5px; font-size: 9px; font-weight: 900; }
        
        /* CASINO ANIM */
        .slot-rolling { filter: blur(4px); transform: translateY(5px); }
    </style>
</head>
<body class="dark bg-mkDark text-white light:bg-mkLight light:text-mkDark">

    <nav class="glass sticky top-0 z-[100] px-8 py-5 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-12">
            <div class="flex items-center gap-4 cursor-pointer" onclick="showSection('shop')">
                <div class="w-12 h-12 bg-mkBlue rounded-2xl flex items-center justify-center font-black text-black text-xl shadow-lg shadow-mkBlue/30">MK</div>
                <div>
                    <h1 class="font-black text-2xl italic tracking-tighter leading-none">MK SHOP</h1>
                    <span class="text-[9px] font-bold text-mkBlue uppercase tracking-widest">Premium System V66</span>
                </div>
            </div>

            <div class="hidden xl:flex items-center gap-8">
                <button onclick="showSection('shop')" class="text-[11px] font-black uppercase hover:text-mkBlue tracking-wider transition">Magasin</button>
                <button onclick="showSection('gamble')" class="text-[11px] font-black uppercase hover:text-mkBlue tracking-wider transition">Casino</button>
                <button onclick="showSection('leaderboard')" class="text-[11px] font-black uppercase hover:text-mkBlue tracking-wider transition">Top Joueurs</button>
                <button onclick="showSection('profile')" class="text-[11px] font-black uppercase hover:text-mkBlue tracking-wider transition">Profil</button>
                <button id="adm-nav" onclick="showSection('admin')" class="hidden text-[11px] font-black uppercase text-mkAdmin border-2 border-mkAdmin/20 px-4 py-2 rounded-xl hover:bg-mkAdmin hover:text-black transition">Console Admin</button>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <div class="flex items-center bg-black/40 rounded-2xl p-1 border border-white/10">
                <button id="btn-mode-cash" onclick="toggleStatMode('cash')" class="px-5 py-2 rounded-xl text-[10px] font-black bg-mkGreen text-black transition">CASH</button>
                <button id="btn-mode-xp" onclick="toggleStatMode('xp')" class="px-5 py-2 rounded-xl text-[10px] font-black opacity-30 hover:opacity-100 transition">XP</button>
            </div>

            <div class="bg-black/30 px-6 py-3 rounded-2xl border border-white/10 min-w-[140px] text-center">
                <span id="nav-val" class="font-black text-lg text-mkGreen">0.00‚Ç¨</span>
            </div>

            <div id="user-panel" class="hidden flex items-center gap-4">
                <img id="nav-pfp" src="" class="w-11 h-11 rounded-2xl border-2 border-mkBlue object-cover">
                <button onclick="logout()" class="w-10 h-10 flex items-center justify-center bg-mkRed/10 text-mkRed rounded-xl font-black text-xl hover:bg-mkRed hover:text-white transition">‚úï</button>
            </div>
            <button id="auth-trigger" onclick="openModal('modal-auth')" class="bg-mkBlue text-black px-8 py-3.5 rounded-2xl font-black text-[11px] uppercase shadow-xl shadow-mkBlue/20">Acc√®s Client</button>
            <button onclick="toggleTheme()" class="w-11 h-11 glass rounded-2xl">üåì</button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-8 py-12 lg:pr-[420px]">

        <section id="sect-shop" class="animate-fade space-y-12">
            <div class="flex flex-col gap-2">
                <h2 class="text-6xl font-black italic uppercase tracking-tighter">Nos <span class="text-mkBlue">Services</span></h2>
                <p class="text-white/30 font-bold uppercase text-[11px] tracking-[0.4em]">Le catalogue le plus complet du march√©</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glass p-10 rounded-5xl border-t-8 border-mkBlue group hover:scale-[1.02] transition-transform">
                    <div class="w-16 h-16 bg-mkBlue/10 rounded-3xl flex items-center justify-center text-3xl mb-8">üéÆ</div>
                    <h3 class="text-3xl font-black">COMPTES ROBLOX</h3>
                    <p class="text-xs opacity-50 mt-4 leading-relaxed">Comptes v√©rifi√©s avec skins rares, Robux et acc√®s complet au mail d'origine.</p>
                    <button onclick="createSupportTicket('Achat Roblox')" class="w-full mt-10 bg-white text-black py-5 rounded-2xl font-black text-xs uppercase group-hover:bg-mkBlue transition">Commander</button>
                </div>

                <div class="glass p-10 rounded-5xl border-t-8 border-mkBlue group hover:scale-[1.02] transition-transform">
                    <div class="w-16 h-16 bg-mkBlue/10 rounded-3xl flex items-center justify-center text-3xl mb-8">‚ö°</div>
                    <h3 class="text-3xl font-black">SCRIPTS & EXECUTORS</h3>
                    <p class="text-xs opacity-50 mt-4 leading-relaxed">Les meilleurs cheats ind√©tectables pour vos jeux favoris. Mise √† jour quotidienne.</p>
                    <button onclick="createSupportTicket('Achat Cheat')" class="w-full mt-10 bg-white text-black py-5 rounded-2xl font-black text-xs uppercase group-hover:bg-mkBlue transition">Voir Scripts</button>
                </div>

                <div class="glass p-10 rounded-5xl border-t-8 border-mkYellow group">
                    <div class="w-16 h-16 bg-mkYellow/10 rounded-3xl flex items-center justify-center text-3xl mb-8">üçø</div>
                    <h3 class="text-3xl font-black">PREMIUMS VIPS</h3>
                    <p class="text-xs opacity-50 mt-4 leading-relaxed">Netflix 4K, Disney+, Spotify Premium. Garantie de remplacement 12 mois.</p>
                    <button onclick="createSupportTicket('Achat Premium')" class="w-full mt-10 bg-mkYellow text-black py-5 rounded-2xl font-black text-xs uppercase">Acheter Premium</button>
                </div>

                <div id="tv-card" class="glass p-10 rounded-5xl border-t-8 border-mkPurple text-center">
                    <h3 class="text-2xl font-black text-mkPurple">ACC√àS CIN√âMA</h3>
                    <p class="text-[10px] font-bold opacity-40 mt-2 uppercase tracking-widest">D√©bloquez la section TV Films</p>
                    <div id="tv-ui-logic" class="mt-8 space-y-4">
                        <input id="tv-code" type="text" placeholder="Entrez votre code VIP" class="w-full bg-black/40 p-5 rounded-2xl text-xs outline-none border border-white/5 font-black uppercase">
                        <button onclick="redeemCode('tv-code')" class="w-full bg-mkPurple text-white py-5 rounded-2xl font-black text-xs uppercase shadow-lg shadow-mkPurple/20">Activer l'acc√®s</button>
                    </div>
                </div>
            </div>

            <div class="glass p-12 rounded-[4rem] border-2 border-mkRed flex flex-col lg:flex-row items-center justify-between gap-8">
                <div>
                    <h3 class="text-4xl font-black text-mkRed italic uppercase">Support & Retrait</h3>
                    <p class="text-sm font-bold opacity-40 uppercase tracking-widest mt-2">√âchangez votre cash ou contactez un administrateur</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="createSupportTicket('Support G√©n√©ral')" class="bg-white/5 px-10 py-5 rounded-2xl font-black text-xs uppercase hover:bg-white/10 transition">Ouvrir Ticket</button>
                    <button onclick="createSupportTicket('DEMANDE CASHOUT')" class="bg-mkRed text-white px-12 py-5 rounded-2xl font-black text-xs uppercase shadow-2xl shadow-mkRed/30">Faire un Cashout</button>
                </div>
            </div>
        </section>

        <section id="sect-gamble" class="hidden animate-fade space-y-12">
            <h2 class="text-5xl font-black italic uppercase italic">Espace <span class="text-mkRed">Casino</span></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glass p-12 rounded-[3.5rem] text-center">
                    <div id="coin-visual" class="text-8xl mb-10 transition-transform duration-500">ü™ô</div>
                    <div class="space-y-6">
                        <input id="bet-coin" type="number" value="1" min="1" class="w-32 bg-black/40 p-4 rounded-xl text-center font-black text-xl outline-none border border-white/10">
                        <div class="flex gap-4">
                            <button onclick="gambleCoin('pile')" class="flex-1 bg-mkBlue text-black py-5 rounded-2xl font-black uppercase text-xs">Miser Pile</button>
                            <button onclick="gambleCoin('face')" class="flex-1 bg-mkBlue text-black py-5 rounded-2xl font-black uppercase text-xs">Miser Face</button>
                        </div>
                    </div>
                </div>

                <div class="glass p-12 rounded-[3.5rem] text-center">
                    <div id="slot-machine" class="flex justify-center gap-4 text-5xl py-8 bg-black/50 rounded-3xl mb-10 border border-white/5 shadow-inner">
                        <span id="s1">üíé</span><span id="s2">üíé</span><span id="s3">üíé</span>
                    </div>
                    <input id="bet-slots" type="number" value="5" min="1" class="w-32 bg-black/40 p-4 rounded-xl text-center font-black text-xl outline-none border border-white/10 mb-6">
                    <button onclick="spinSlots()" class="w-full bg-mkPurple text-white py-6 rounded-2xl font-black uppercase text-xs shadow-xl shadow-mkPurple/30">Lancer la machine</button>
                </div>
            </div>
        </section>

        <section id="sect-leaderboard" class="hidden animate-fade space-y-10">
            <h2 class="text-5xl font-black italic text-center uppercase tracking-tighter">Les Plus <span class="text-mkGreen">Riches</span></h2>
            <div id="lead-container" class="glass rounded-[3rem] overflow-hidden shadow-2xl border border-white/10">
                </div>
        </section>

        <section id="sect-profile" class="hidden animate-fade max-w-2xl mx-auto space-y-8">
            <div class="glass p-5 rounded-2xl flex gap-4">
                <input id="find-user" type="text" placeholder="Chercher un membre..." class="flex-1 bg-transparent px-6 font-bold outline-none">
                <button onclick="searchProfile()" class="bg-mkBlue text-black px-8 py-4 rounded-xl font-black text-xs uppercase">Rechercher</button>
            </div>

            <div id="profile-box" class="glass p-16 rounded-[4rem] text-center border-b-8 border-mkBlue">
                <img id="p-img" src="" class="w-40 h-40 rounded-[3rem] mx-auto border-4 border-mkDark shadow-2xl mb-8 object-cover">
                <h3 id="p-user" class="text-4xl font-black italic uppercase tracking-tighter">Profil</h3>
                
                <div class="grid grid-cols-2 gap-6 mt-12">
                    <div class="bg-black/40 p-8 rounded-3xl">
                        <p class="text-[9px] font-black opacity-30 uppercase tracking-widest">Solde actuel</p>
                        <p id="p-cash" class="text-3xl font-black text-mkGreen mt-2">0.00‚Ç¨</p>
                    </div>
                    <div class="bg-black/40 p-8 rounded-3xl">
                        <p class="text-[9px] font-black opacity-30 uppercase tracking-widest">Exp√©rience</p>
                        <p id="p-xp" class="text-3xl font-black text-mkYellow mt-2">0 XP</p>
                    </div>
                </div>

                <div id="profile-edit" class="mt-12 pt-12 border-t border-white/5 space-y-6">
                    <div class="text-left space-y-2">
                        <label class="text-[9px] font-black uppercase opacity-30 ml-2">Modifier l'avatar (Lien image)</label>
                        <input id="p-new-pfp" type="text" placeholder="https://..." class="w-full bg-black/40 p-5 rounded-2xl text-xs outline-none">
                        <button onclick="updatePfp()" class="w-full bg-white text-black py-4 rounded-2xl font-black text-[10px] uppercase">Mettre √† jour l'image</button>
                    </div>
                    <div class="text-left space-y-2 pt-4">
                        <label class="text-[9px] font-black uppercase opacity-30 ml-2">Appliquer un code</label>
                        <div class="flex gap-3">
                            <input id="p-code-in" type="text" placeholder="CODE SECRET" class="flex-1 bg-black/40 p-5 rounded-2xl text-xs font-black uppercase outline-none">
                            <button onclick="redeemCode('p-code-in')" class="bg-mkPurple text-white px-8 rounded-2xl font-black text-[10px] uppercase">Valider</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="sect-tv" class="hidden animate-fade space-y-8">
            <h2 class="text-4xl font-black text-mkPurple italic uppercase">MK TV VIP</h2>
            <div class="bg-black aspect-video rounded-[3rem] overflow-hidden border-8 border-mkPurple/10 shadow-2xl">
                <iframe id="tv-player" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="flex gap-4 overflow-x-auto p-4 no-scrollbar">
                <button onclick="loadTV('https://www.youtube.com/embed/S8_YwFLCh4U')" class="bg-white/5 px-8 py-4 rounded-2xl font-black text-[10px] whitespace-nowrap">ANIME MOVIE 1</button>
                <button onclick="loadTV('https://www.youtube.com/embed/1vRzN7p0f8Y')" class="bg-white/5 px-8 py-4 rounded-2xl font-black text-[10px] whitespace-nowrap">ANIME MOVIE 2</button>
                <button onclick="loadTV('https://www.youtube.com/embed/Sx-C5yF2yJk')" class="bg-white/5 px-8 py-4 rounded-2xl font-black text-[10px] whitespace-nowrap">ANIME MOVIE 3</button>
            </div>
        </section>

        <section id="sect-admin" class="hidden animate-fade space-y-12">
            <div class="flex justify-between items-end">
                <h2 class="text-5xl font-black text-mkAdmin italic uppercase tracking-tighter">Console Supr√™me</h2>
                <button onclick="loadAdminData()" class="bg-mkAdmin/10 text-mkAdmin px-6 py-3 rounded-xl font-black text-[10px] uppercase border border-mkAdmin/20">Sync Database</button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
                <div class="space-y-6">
                    <h3 class="font-black text-xs uppercase tracking-widest text-mkRed">Tickets en attente</h3>
                    <div id="adm-tickets" class="space-y-4"></div>
                </div>
                <div class="space-y-6">
                    <h3 class="font-black text-xs uppercase tracking-widest text-mkBlue">Gestion des Membres</h3>
                    <div id="adm-users" class="space-y-4 max-h-[700px] overflow-y-auto no-scrollbar pr-2"></div>
                </div>
            </div>
        </section>

    </main>

    <aside id="chat-bar" class="fixed right-10 top-32 bottom-12 w-[340px] glass rounded-[3rem] hidden xl:flex flex-col overflow-hidden border border-white/5">
        <div class="p-8 bg-white/5 border-b border-white/5">
            <h4 class="text-[12px] font-black uppercase tracking-[0.3em] text-mkBlue italic">Chat Global</h4>
        </div>
        
        <div id="chat-content" class="flex-1 p-6 overflow-y-auto space-y-6 no-scrollbar">
            </div>

        <div class="p-6 border-t border-white/5">
            <div class="bg-black/50 rounded-2xl p-2 flex gap-2 border border-white/10">
                <input id="chat-input" type="text" placeholder="Votre message..." class="bg-transparent outline-none flex-1 px-4 text-[11px] font-semibold">
                <button onclick="sendMessage()" class="w-12 h-12 bg-mkBlue text-black rounded-xl flex items-center justify-center font-black">></button>
            </div>
        </div>
    </aside>

    <div id="modal-auth" class="fixed inset-0 z-[2000] bg-black/95 flex items-center justify-center p-8 hidden backdrop-blur-md">
        <div class="glass w-full max-w-md rounded-[3.5rem] p-12 text-center animate-fade border-t-8 border-mkBlue">
            <h3 class="text-4xl font-black italic uppercase tracking-tighter">Acc√®s Client</h3>
            <p class="text-white/30 font-bold text-[10px] uppercase mt-3 mb-10 tracking-widest">Inscrivez-vous ou connectez-vous</p>
            
            <div class="space-y-4">
                <input id="auth-email" type="email" placeholder="Email (Unique)" class="w-full bg-white/5 p-5 rounded-2xl outline-none border border-white/5 text-xs font-bold">
                <input id="auth-user" type="text" placeholder="Pseudo MK" class="w-full bg-white/5 p-5 rounded-2xl outline-none border border-white/5 text-xs font-bold">
                <input id="auth-pass" type="password" placeholder="Mot de passe" class="w-full bg-white/5 p-5 rounded-2xl outline-none border border-white/5 text-xs font-bold">
                <button onclick="handleAuth()" class="w-full bg-mkBlue text-black py-5 rounded-2xl font-black text-xs uppercase shadow-2xl shadow-mkBlue/20 mt-6">D√©marrer la Session</button>
                <button onclick="closeModal('modal-auth')" class="text-[10px] font-black opacity-30 uppercase tracking-widest mt-4">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const SB_URL = "https://eeiuxfcgysrarctokuyg.supabase.co"; 
        const SB_KEY = "sb_publishable_0fuup_i-vDgKHozqpz706A_4tGWghxn";
        const db = supabase.createClient(SB_URL, SB_KEY);

        let user = null;
        let statMode = 'cash';

        // NOTIFICATIONS
        function toast(msg, type = 'mkBlue') {
            const t = document.createElement('div');
            t.className = 'toast';
            t.style.background = '#000';
            t.style.borderLeft = `8px solid var(--${type})`;
            t.innerHTML = `<span class="text-white font-black uppercase text-xs">${msg}</span>`;
            document.body.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 3000);
        }

        // NAVIGATION & UI
        function toggleTheme() {
            document.body.classList.toggle('light');
            document.body.classList.toggle('dark');
        }

        function toggleStatMode(m) {
            statMode = m;
            document.getElementById('btn-mode-cash').className = m === 'cash' ? 'px-5 py-2 rounded-xl text-[10px] font-black bg-mkGreen text-black transition' : 'px-5 py-2 rounded-xl text-[10px] font-black opacity-30 hover:opacity-100 transition';
            document.getElementById('btn-mode-xp').className = m === 'xp' ? 'px-5 py-2 rounded-xl text-[10px] font-black bg-mkYellow text-black transition' : 'px-5 py-2 rounded-xl text-[10px] font-black opacity-30 hover:opacity-100 transition';
            syncUI();
        }

        function showSection(id) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById('sect-' + id).classList.remove('hidden');
            if(id === 'leaderboard') fetchLeaderboard();
            if(id === 'admin') loadAdminData();
            if(id === 'profile') renderProfile(user);
        }

        // AUTHENTIFICATION (LE TRUC D'AVANT)
        async function handleAuth() {
            const e = document.getElementById('auth-email').value.trim();
            const u = document.getElementById('auth-user').value.trim();
            const p = document.getElementById('auth-pass').value.trim();

            if(!e || !p) return toast("Email et Passe requis !", "mkRed");

            // Check existant
            let { data: profile } = await db.from('profiles').select('*').eq('email', e).maybeSingle();

            if(!profile) {
                // Cr√©ation si nouveau
                const { data, error } = await db.from('profiles').insert([{
                    email: e, username: u || "User" + Math.floor(Math.random()*1000),
                    password: p, balance: 10.00, xp: 0,
                    pfp: `https://api.dicebear.com/7.x/pixel-art/svg?seed=${e}`,
                    tv_access: false, banned: false
                }]).select().single();
                if(error) return toast("Erreur cr√©ation", "mkRed");
                profile = data;
                toast("Compte cr√©√© ! +10‚Ç¨ offerts", "mkGreen");
            } else {
                // Verif pass
                if(profile.password !== p) return toast("Mot de passe incorrect", "mkRed");
                toast(`Bon retour, ${profile.username}`);
            }

            if(profile.banned) return toast("VOUS √äTES BANNI", "mkRed");

            user = profile;
            localStorage.setItem('mk_session', JSON.stringify(user));
            closeModal('modal-auth');
            initUser();
        }

        function initUser() {
            if(!user) return;
            document.getElementById('auth-trigger').classList.add('hidden');
            document.getElementById('user-panel').classList.remove('hidden');
            document.getElementById('nav-pfp').src = user.pfp;
            
            if(user.username.toLowerCase() === 'admin') {
                document.getElementById('adm-nav').classList.remove('hidden');
            }
            if(user.tv_access) {
                document.getElementById('tv-ui-logic').innerHTML = `<button onclick="showSection('tv')" class="w-full bg-mkGreen text-black py-5 rounded-2xl font-black text-xs uppercase animate-pulse">Entrer au Cin√©ma</button>`;
            }
            syncUI();
            startChatLoop();
        }

        function syncUI() {
            if(!user) return;
            const display = document.getElementById('nav-val');
            if(statMode === 'cash') {
                display.innerText = user.balance.toFixed(2) + "‚Ç¨";
                display.className = "font-black text-lg text-mkGreen";
            } else {
                display.innerText = user.xp + " XP";
                display.className = "font-black text-lg text-mkYellow";
            }
        }

        // CASINO
        async function updateBalance(newBal, xpAdd = 10) {
            const { data, error } = await db.from('profiles').update({ balance: newBal, xp: user.xp + xpAdd }).eq('id', user.id).select().single();
            if(!error) { user = data; syncUI(); }
        }

        async function gambleCoin(side) {
            const bet = parseFloat(document.getElementById('bet-coin').value);
            if(!user || bet > user.balance || bet <= 0) return toast("Mise impossible", "mkRed");

            const win = Math.random() > 0.55;
            const res = win ? side : (side === 'pile' ? 'face' : 'pile');
            
            document.getElementById('coin-visual').style.transform = "rotateY(1080deg)";
            setTimeout(async () => {
                document.getElementById('coin-visual').style.transform = "rotateY(0deg)";
                const final = win ? user.balance + bet : user.balance - bet;
                await updateBalance(final, 20);
                toast(win ? "GAGN√â !" : "PERDU", win ? "mkGreen" : "mkRed");
            }, 600);
        }

        async function spinSlots() {
            const bet = parseFloat(document.getElementById('bet-slots').value);
            if(!user || bet > user.balance || bet <= 0) return toast("Fonds insuffisants", "mkRed");

            const machine = [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3')];
            machine.forEach(s => s.classList.add('slot-rolling'));

            setTimeout(async () => {
                machine.forEach(s => s.classList.remove('slot-rolling'));
                const items = ['üíé', 'üçí', 'üçã', 'üçá', '‚≠ê'];
                const res = [items[Math.floor(Math.random()*5)], items[Math.floor(Math.random()*5)], items[Math.floor(Math.random()*5)]];
                machine[0].innerText = res[0]; machine[1].innerText = res[1]; machine[2].innerText = res[2];

                let mult = 0;
                if(res[0] === res[1] && res[1] === res[2]) mult = 10;
                else if(res[0] === res[1] || res[1] === res[2] || res[0] === res[2]) mult = 2;

                const winAmt = bet * mult;
                await updateBalance((user.balance - bet) + winAmt, 30);
                if(mult > 0) toast(`JACKPOT x${mult} !`, "mkPurple");
            }, 1000);
        }

        // CODES & TICKETS
        async function redeemCode(inputId) {
            const c = document.getElementById(inputId).value.trim().toUpperCase();
            if(!c || !user) return;

            if(c === 'LXS-1') {
                await updateBalance(user.balance + 15, 50);
                toast("Code : +15‚Ç¨ !", "mkGreen");
            } else if(c === 'TVVIP') {
                const { data } = await db.from('profiles').update({ tv_access: true }).eq('id', user.id).select().single();
                user = data;
                initUser();
                toast("Cin√©ma d√©bloqu√© !", "mkPurple");
            } else {
                toast("Code erron√©", "mkRed");
            }
            document.getElementById(inputId).value = "";
        }

        async function createSupportTicket(type) {
            if(!user) return toast("Connectez-vous", "mkRed");
            await db.from('tickets').insert([{ username: user.username, type: type, status: 'open' }]);
            toast("Ticket ouvert !", "mkGreen");
        }

        // PROFIL
        function renderProfile(u) {
            if(!u) return;
            document.getElementById('p-img').src = u.pfp;
            document.getElementById('p-user').innerText = u.username;
            document.getElementById('p-cash').innerText = u.balance.toFixed(2) + "‚Ç¨";
            document.getElementById('p-xp').innerText = u.xp + " XP";
            document.getElementById('profile-edit').classList.remove('hidden');
        }

        async function searchProfile() {
            const q = document.getElementById('find-user').value.trim();
            const { data } = await db.from('profiles').select('*').eq('username', q).maybeSingle();
            if(data) {
                renderProfile(data);
                document.getElementById('profile-edit').classList.add('hidden');
            } else toast("Inconnu", "mkRed");
        }

        async function updatePfp() {
            const url = document.getElementById('p-new-pfp').value;
            if(!url) return;
            const { data } = await db.from('profiles').update({ pfp: url }).eq('id', user.id).select().single();
            user = data;
            initUser();
            renderProfile(user);
            toast("Photo mise √† jour");
        }

        // ADMIN
        async function loadAdminData() {
            const { data: users } = await db.from('profiles').select('*');
            const { data: tickets } = await db.from('tickets').select('*').eq('status', 'open');

            document.getElementById('adm-tickets').innerHTML = (tickets||[]).map(t => `
                <div class="glass p-6 rounded-2xl flex justify-between items-center border-l-4 border-mkRed">
                    <div class="text-[11px] font-black uppercase tracking-widest">${t.type} <br> <span class="opacity-40">${t.username}</span></div>
                    <button onclick="closeT('${t.id}')" class="bg-mkRed text-white px-5 py-2 rounded-xl text-[10px] font-black">OK</button>
                </div>
            `).join('');

            document.getElementById('adm-users').innerHTML = users.map(u => `
                <div class="glass p-5 rounded-2xl space-y-3 border border-white/5">
                    <div class="flex justify-between font-black text-[10px] uppercase">
                        <span>${u.username}</span> <span class="text-mkBlue">${u.password}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="admAct('${u.id}', {balance: ${u.balance+10}})" class="flex-1 bg-mkGreen/20 text-mkGreen p-2 rounded-lg text-[10px] font-black">+10‚Ç¨</button>
                        <button onclick="admAct('${u.id}', {banned: ${!u.banned}})" class="flex-1 bg-white/10 p-2 rounded-lg text-[10px] font-black">BAN</button>
                    </div>
                </div>
            `).join('');
        }

        async function admAct(id, o) { await db.from('profiles').update(o).eq('id', id); loadAdminData(); }
        async function closeT(id) { await db.from('tickets').update({status:'closed'}).eq('id', id); loadAdminData(); }

        // CHAT LOOP
        async function sendMessage() {
            const i = document.getElementById('chat-input');
            if(!user || !i.value) return;
            await db.from('messages').insert([{ 
                username: user.username, content: i.value, 
                pfp: user.pfp, level: Math.floor(user.xp/100) 
            }]);
            i.value = "";
            fetchChat();
        }

        async function fetchChat() {
            const { data } = await db.from('messages').select('*').order('created_at', { ascending: false }).limit(20);
            if(!data) return;
            const container = document.getElementById('chat-content');
            container.innerHTML = data.reverse().map(m => {
                const isAdmin = m.username.toLowerCase() === 'admin';
                return `
                <div class="chat-msg flex gap-3 items-start">
                    <img src="${m.pfp}" class="w-9 h-9 rounded-xl shadow-lg">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            ${isAdmin ? '<span class="badge-admin">STAFF</span>' : `<span class="text-[8px] bg-mkBlue/20 text-mkBlue px-2 rounded">LVL ${m.level}</span>`}
                            <b class="text-[10px] uppercase">${m.username}</b>
                        </div>
                        <p class="text-[11px] opacity-70 mt-1">${m.content}</p>
                    </div>
                </div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        async function fetchLeaderboard() {
            const { data } = await db.from('profiles').select('*').order('balance', { ascending: false }).limit(10);
            document.getElementById('lead-container').innerHTML = data.map((u, i) => `
                <div class="p-6 border-b border-white/5 flex justify-between items-center hover:bg-white/5 transition">
                    <div class="flex items-center gap-6">
                        <span class="text-2xl font-black italic opacity-10">#${i+1}</span>
                        <img src="${u.pfp}" class="w-10 h-10 rounded-xl">
                        <b class="uppercase italic text-sm tracking-tighter">${u.username}</b>
                    </div>
                    <b class="text-mkGreen text-lg">${u.balance.toFixed(2)}‚Ç¨</b>
                </div>
            `).join('');
        }

        function startChatLoop() { fetchChat(); setInterval(fetchChat, 4000); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function loadTV(u) { document.getElementById('tv-player').src = u; toast("Lancement VIP..."); }
        function logout() { localStorage.clear(); location.reload(); }

        window.onload = () => {
            const saved = localStorage.getItem('mk_session');
            if(saved) {
                user = JSON.parse(saved);
                db.from('profiles').select('*').eq('id', user.id).single().then(({data}) => {
                    if(data) { user = data; initUser(); }
                });
            }
        };
    </script>
</body>
</html>
