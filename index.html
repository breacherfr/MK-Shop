<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK SHOP - SUPREME V69</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        mkBlue: '#00d2ff', mkRed: '#ff4b5c', mkPurple: '#a363ff',
                        mkYellow: '#fbbf24', mkGreen: '#22c55e', mkAdmin: '#ff00ff',
                        mkDark: '#030303'
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '3.5rem' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; transition: 0.4s; background-color: #030303; color: #fff; overflow-x: hidden; }
        .glass { backdrop-filter: blur(25px); background: rgba(8, 8, 10, 0.96); border: 1px solid rgba(255, 255, 255, 0.05); }
        .light { background-color: #f0f2f5; color: #1a1a1a; }
        .light .glass { background: rgba(245, 245, 250, 0.9); }
        
        @keyframes slide { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .animate-view { animation: slide 0.4s ease-out; }
        
        .toast { position: fixed; top: 30px; right: 30px; z-index: 10000; padding: 15px 30px; border-radius: 15px; background: #000; border-left: 5px solid #00d2ff; font-weight: 800; font-size: 12px; pointer-events: none; }
        
        #mini-chat { position: fixed; bottom: 30px; right: 30px; width: 350px; height: 500px; z-index: 5000; display: none; flex-direction: column; border-radius: 2.5rem; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animation fluide pour les messages */
        .msg-item { transition: all 0.3s ease; }
    </style>
</head>
<body class="dark">

    <nav class="glass sticky top-0 z-[1000] px-10 py-6 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-10">
            <div class="flex items-center gap-3 cursor-pointer" onclick="showSection('shop')">
                <div class="w-12 h-12 bg-mkBlue rounded-xl flex items-center justify-center font-black text-black shadow-lg shadow-mkBlue/20">MK</div>
                <div>
                    <h1 class="font-black text-xl italic tracking-tighter leading-none">MK SHOP</h1>
                    <span class="text-[8px] font-bold text-mkBlue uppercase tracking-widest opacity-70">Supreme V69</span>
                </div>
            </div>
            <div class="hidden lg:flex gap-8">
                <button onclick="showSection('shop')" class="text-[10px] font-black uppercase hover:text-mkBlue transition tracking-widest">March√©</button>
                <button onclick="showSection('games')" class="text-[10px] font-black uppercase hover:text-mkBlue transition tracking-widest">Casino</button>
                <button onclick="showSection('leaderboard')" class="text-[10px] font-black uppercase hover:text-mkBlue transition tracking-widest">Top</button>
                <button onclick="showSection('profile')" class="text-[10px] font-black uppercase hover:text-mkBlue transition tracking-widest">Profil</button>
                <button id="nav-admin" onclick="showSection('admin')" class="hidden text-[10px] font-black uppercase text-mkAdmin border border-mkAdmin/30 px-3 py-1.5 rounded-lg">Console</button>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="flex bg-black/40 rounded-xl p-1 border border-white/10">
                <button id="m-cash" onclick="setMode('cash')" class="px-4 py-2 rounded-lg text-[9px] font-black bg-mkGreen text-black transition">CASH</button>
                <button id="m-xp" onclick="setMode('xp')" class="px-4 py-2 rounded-lg text-[9px] font-black opacity-30 transition">XP</button>
            </div>
            <div class="bg-black/20 px-5 py-2 rounded-xl border border-white/5 min-w-[110px] text-center">
                <span id="val-display" class="font-black text-sm text-mkGreen">0.00‚Ç¨</span>
            </div>
            <div id="auth-zone">
                <button onclick="openModal('modal-auth')" class="bg-mkBlue text-black px-5 py-2.5 rounded-xl font-black text-[9px] uppercase shadow-lg shadow-mkBlue/10">Connexion</button>
            </div>
            <div id="user-zone" class="hidden flex items-center gap-3">
                <img id="u-pfp" src="" class="w-10 h-10 rounded-xl border-2 border-mkBlue object-cover shadow-lg">
                <button onclick="logout()" class="text-mkRed font-black hover:scale-110 transition">‚úï</button>
            </div>
            <button onclick="toggleTheme()" class="w-10 h-10 glass rounded-xl flex items-center justify-center hover:bg-white/5 transition">üåì</button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-6 py-12 lg:pr-[390px]">

        <section id="s-shop" class="animate-view space-y-12">
            <div class="flex justify-between items-end">
                <h2 class="text-6xl font-black italic uppercase">Le <span class="text-mkBlue">Market</span></h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glass p-10 rounded-5xl border-t-4 border-mkBlue hover:translate-y-[-5px] transition-all duration-300">
                    <span class="text-4xl">üéÆ</span>
                    <h3 class="text-2xl font-black uppercase mt-6">Comptes Roblox</h3>
                    <p class="text-[11px] opacity-40 mt-3 leading-relaxed">Acc√®s complet √† des comptes avec skins limit√©s, Korblox et Headless.</p>
                    <button onclick="openTicket('Achat Roblox')" class="w-full mt-8 bg-white text-black py-4 rounded-2xl font-black text-[10px] uppercase hover:bg-mkBlue transition">Acheter maintenant</button>
                </div>
                <div class="glass p-10 rounded-5xl border-t-4 border-mkBlue hover:translate-y-[-5px] transition-all duration-300">
                    <span class="text-4xl">‚ö°</span>
                    <h3 class="text-2xl font-black uppercase mt-6">Logiciels & Cheats</h3>
                    <p class="text-[11px] opacity-40 mt-3 leading-relaxed">Injecteurs premium et scripts exclusifs pour dominer vos jeux favoris.</p>
                    <button onclick="openTicket('Achat Cheat')" class="w-full mt-8 bg-white text-black py-4 rounded-2xl font-black text-[10px] uppercase hover:bg-mkBlue transition">Voir le catalogue</button>
                </div>
                <div class="glass p-10 rounded-5xl border-t-4 border-mkYellow hover:translate-y-[-5px] transition-all duration-300">
                    <span class="text-4xl">üçø</span>
                    <h3 class="text-2xl font-black uppercase mt-6">Services Premium</h3>
                    <p class="text-[11px] opacity-40 mt-3 leading-relaxed">Abonnements Netflix, Disney+ et Spotify √† des prix imbattables.</p>
                    <button onclick="openTicket('Achat Premium')" class="w-full mt-8 bg-mkYellow text-black py-4 rounded-2xl font-black text-[10px] uppercase">S'abonner</button>
                </div>
                <div id="tv-card" class="glass p-10 rounded-5xl border-t-4 border-mkPurple overflow-hidden relative">
                    <div class="relative z-10">
                        <h3 class="text-2xl font-black uppercase text-mkPurple">MK Cinema VIP</h3>
                        <p class="text-[11px] opacity-40 mt-3 leading-relaxed">D√©bloquez l'acc√®s √† notre plateforme de streaming priv√©e.</p>
                        <div id="tv-action" class="mt-8 space-y-3">
                            <input id="tv-code" type="text" placeholder="Entrer Code VIP" class="w-full bg-black/40 p-4 rounded-xl text-[10px] font-black uppercase outline-none border border-white/5 focus:border-mkPurple transition">
                            <button onclick="unlockTV()" class="w-full bg-mkPurple text-white py-4 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-mkPurple/20">Valider l'acc√®s</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="glass p-12 rounded-[4rem] border-2 border-mkRed flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="text-center md:text-left">
                    <h3 class="text-4xl font-black text-mkRed uppercase italic">Assistance</h3>
                    <p class="text-[10px] opacity-30 uppercase font-bold tracking-[0.2em] mt-2">Tickets Support & Retrait d'argent</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="openTicket('Support')" class="bg-white/5 border border-white/10 px-8 py-4 rounded-2xl font-black text-[10px] uppercase hover:bg-white/10 transition">Support</button>
                    <button onclick="openTicket('CASHOUT')" class="bg-mkRed text-white px-8 py-4 rounded-2xl font-black text-[10px] uppercase shadow-xl shadow-mkRed/20 hover:scale-105 transition">Retirer Cash</button>
                </div>
            </div>
        </section>

        <section id="s-games" class="hidden animate-view space-y-12">
            <h2 class="text-5xl font-black italic uppercase">MK <span class="text-mkRed">Casino</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glass p-10 rounded-5xl text-center">
                    <div id="coin-res" class="text-8xl mb-10 transition-all duration-500">ü™ô</div>
                    <div class="mb-8">
                        <label class="block text-[10px] font-black opacity-30 uppercase mb-3">Mise</label>
                        <input id="bet-coin" type="number" value="5" class="bg-black/40 p-4 rounded-2xl w-32 text-center font-black text-xl outline-none border border-white/5">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="playGame('coin', 'pile')" class="flex-1 bg-mkBlue text-black py-4 rounded-2xl font-black text-[10px] uppercase hover:scale-105 transition">Miser Pile</button>
                        <button onclick="playGame('coin', 'face')" class="flex-1 bg-mkBlue text-black py-4 rounded-2xl font-black text-[10px] uppercase hover:scale-105 transition">Miser Face</button>
                    </div>
                </div>
                <div class="glass p-10 rounded-5xl text-center">
                    <div class="flex justify-center gap-4 text-6xl mb-10 bg-black/50 p-8 rounded-3xl border border-white/5">
                        <span id="sl1" class="msg-item">üíé</span>
                        <span id="sl2" class="msg-item">üíé</span>
                        <span id="sl3" class="msg-item">üíé</span>
                    </div>
                    <div class="mb-8">
                        <label class="block text-[10px] font-black opacity-30 uppercase mb-3">Mise</label>
                        <input id="bet-slots" type="number" value="10" class="bg-black/40 p-4 rounded-2xl w-32 text-center font-black text-xl outline-none border border-white/5">
                    </div>
                    <button onclick="playGame('slots')" class="w-full bg-mkPurple text-white py-4 rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-mkPurple/20">Lancer la machine</button>
                </div>
            </div>
        </section>

        <section id="s-profile" class="hidden animate-view max-w-xl mx-auto space-y-8">
            <div class="glass p-4 rounded-2xl flex gap-3">
                <input id="search-name" type="text" placeholder="Rechercher un membre..." class="flex-1 bg-transparent px-4 text-xs font-bold outline-none uppercase tracking-widest">
                <button onclick="findMember()" class="bg-mkBlue text-black px-6 py-3 rounded-xl font-black text-[9px] uppercase hover:bg-white transition">Chercher</button>
            </div>

            <div id="p-card" class="glass p-12 rounded-[4rem] text-center border-b-[12px] border-mkBlue">
                <img id="p-avatar" src="" class="w-36 h-36 rounded-[3rem] mx-auto object-cover border-4 border-mkDark shadow-2xl mb-8">
                <h3 id="p-username" class="text-4xl font-black italic uppercase tracking-tighter">Utilisateur</h3>
                
                <div class="grid grid-cols-2 gap-4 mt-10">
                    <div class="bg-black/40 p-7 rounded-[2.5rem] border border-white/5">
                        <p class="text-[9px] opacity-30 font-black uppercase mb-1">Balance</p>
                        <p id="p-val-cash" class="text-2xl font-black text-mkGreen">0.00‚Ç¨</p>
                    </div>
                    <div class="bg-black/40 p-7 rounded-[2.5rem] border border-white/5">
                        <p class="text-[9px] opacity-30 font-black uppercase mb-1">Exp√©rience</p>
                        <p id="p-val-xp" class="text-2xl font-black text-mkYellow">0 XP</p>
                    </div>
                </div>

                <div id="p-controls" class="mt-10 pt-10 border-t border-white/5 space-y-6 text-left">
                    <div>
                        <label class="text-[9px] font-black uppercase opacity-40 ml-2">Photo de profil (URL)</label>
                        <div class="flex gap-2 mt-2">
                            <input id="new-pfp-url" type="text" placeholder="https://..." class="flex-1 bg-black/40 p-4 rounded-xl text-[10px] outline-none border border-white/5 focus:border-mkBlue transition">
                            <button onclick="updatePfp()" class="bg-white text-black px-6 rounded-xl font-black text-[9px] uppercase hover:bg-mkBlue transition">Maj</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase opacity-40 ml-2">Code Cadeau</label>
                        <div class="flex gap-2 mt-2">
                            <input id="promo-code" type="text" placeholder="XXXX-XXXX" class="flex-1 bg-black/40 p-4 rounded-xl text-[10px] font-black uppercase outline-none border border-white/5">
                            <button onclick="usePromo()" class="bg-mkPurple text-white px-6 rounded-xl font-black text-[9px] uppercase">Activer</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="s-leaderboard" class="hidden animate-view space-y-8">
            <h2 class="text-5xl font-black text-center italic uppercase">Top <span class="text-mkGreen">Richesse</span></h2>
            <div id="leader-container" class="glass rounded-[3rem] overflow-hidden border border-white/5">
                </div>
        </section>

        <section id="s-tv" class="hidden animate-view space-y-8">
            <h2 class="text-4xl font-black text-mkPurple italic uppercase">MK VIP Cinema</h2>
            <div class="bg-black rounded-[4xl] overflow-hidden border-8 border-white/5 aspect-video shadow-2xl">
                <iframe id="tv-frame" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="flex gap-4 overflow-x-auto pb-4 no-scrollbar">
                <button onclick="setFilm('https://www.youtube.com/embed/S8_YwFLCh4U')" class="bg-white/5 border border-white/10 px-8 py-4 rounded-2xl font-black text-[10px] whitespace-nowrap hover:bg-mkPurple transition">ACTION BLOCKBUSTER</button>
                <button onclick="setFilm('https://www.youtube.com/embed/1vRzN7p0f8Y')" class="bg-white/5 border border-white/10 px-8 py-4 rounded-2xl font-black text-[10px] whitespace-nowrap hover:bg-mkPurple transition">ANIME MOVIE 1</button>
                <button onclick="setFilm('https://www.youtube.com/embed/dQw4w9WgXcQ')" class="bg-white/5 border border-white/10 px-8 py-4 rounded-2xl font-black text-[10px] whitespace-nowrap hover:bg-mkPurple transition">CONCERT LIVE</button>
            </div>
        </section>

        <section id="s-admin" class="hidden animate-view space-y-12">
            <h2 class="text-5xl font-black text-mkAdmin italic uppercase">Console Supr√™me</h2>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
                <div>
                    <h3 class="text-[11px] font-black uppercase text-mkRed mb-6 tracking-widest">Tickets Ouverts</h3>
                    <div id="adm-tickets" class="space-y-4"></div>
                </div>
                <div>
                    <h3 class="text-[11px] font-black uppercase text-mkBlue mb-6 tracking-widest">Base de Donn√©es Membres</h3>
                    <div id="adm-users" class="space-y-4 max-h-[600px] overflow-y-auto pr-4 no-scrollbar"></div>
                </div>
            </div>
        </section>

    </main>

    <button onclick="toggleChat()" class="fixed bottom-10 right-10 w-20 h-20 bg-mkBlue rounded-3xl shadow-2xl flex items-center justify-center text-3xl z-[6000] hover:scale-110 active:scale-95 transition-all">üí¨</button>
    
    <div id="mini-chat" class="glass">
        <div class="p-8 bg-white/5 border-b border-white/5 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 bg-mkGreen rounded-full animate-pulse"></div>
                <span class="text-[11px] font-black uppercase tracking-widest text-mkBlue">Chat Global</span>
            </div>
            <button onclick="toggleChat()" class="text-white/20 hover:text-white transition">‚úï</button>
        </div>
        
        <div id="chat-flow" class="flex-1 p-6 overflow-y-auto space-y-6 no-scrollbar scroll-smooth">
            </div>
        
        <div class="p-6 border-t border-white/5">
            <div class="bg-black/50 rounded-2xl p-2 flex gap-2 border border-white/10 focus-within:border-mkBlue/50 transition">
                <input id="chat-input" type="text" placeholder="Votre message..." class="bg-transparent flex-1 outline-none px-4 text-[11px] font-bold">
                <button onclick="sendChatMessage()" class="w-12 h-12 bg-mkBlue text-black rounded-xl font-black text-lg shadow-lg shadow-mkBlue/20 hover:bg-white transition">></button>
            </div>
        </div>
    </div>

    <div id="modal-auth" class="fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center p-6 hidden">
        <div class="glass w-full max-w-sm rounded-[4rem] p-12 text-center border-t-8 border-mkBlue">
            <h3 class="text-4xl font-black italic uppercase tracking-tighter">Acc√®s Client</h3>
            <p class="text-[10px] font-bold opacity-30 uppercase mt-3 mb-10 tracking-widest">Inscrivez-vous pour d√©bloquer le shop</p>
            <div class="space-y-4">
                <input id="in-email" type="email" placeholder="EMAIL" class="w-full bg-white/5 p-5 rounded-2xl outline-none text-[11px] font-bold border border-white/5 focus:border-mkBlue transition">
                <input id="in-user" type="text" placeholder="PSEUDO" class="w-full bg-white/5 p-5 rounded-2xl outline-none text-[11px] font-bold border border-white/5 focus:border-mkBlue transition">
                <input id="in-pass" type="password" placeholder="MOT DE PASSE" class="w-full bg-white/5 p-5 rounded-2xl outline-none text-[11px] font-bold border border-white/5 focus:border-mkBlue transition">
                <button onclick="processAuth()" class="w-full bg-mkBlue text-black py-5 rounded-2xl font-black text-xs uppercase mt-6 shadow-xl shadow-mkBlue/20 hover:bg-white transition">Se connecter / S'inscrire</button>
                <button onclick="closeModal('modal-auth')" class="text-[9px] font-black opacity-30 uppercase mt-4 hover:opacity-100 transition">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION SUPABASE
        const SB_URL = "https://eeiuxfcgysrarctokuyg.supabase.co";
        const SB_KEY = "sb_publishable_0fuup_i-vDgKHozqpz706A_4tGWghxn";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let user = null;
        let currentMode = 'cash';
        let chatLoop = null;
        let lastMsgCount = 0;

        function toast(msg, color='mkBlue') {
            const el = document.createElement('div');
            el.className = 'toast animate-view';
            el.style.borderLeftColor = `var(--${color})`;
            el.innerText = msg;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function toggleTheme() { document.body.classList.toggle('light'); document.body.classList.toggle('dark'); }

        function showSection(id) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById('s-' + id).classList.remove('hidden');
            if(id === 'leaderboard') loadLeaderboard();
            if(id === 'admin') loadAdminPanel();
            if(id === 'profile') renderProfile(user);
            window.scrollTo(0,0);
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('m-cash').className = m === 'cash' ? 'px-4 py-2 rounded-lg text-[9px] font-black bg-mkGreen text-black transition' : 'px-4 py-2 rounded-lg text-[9px] font-black opacity-30 transition';
            document.getElementById('m-xp').className = m === 'xp' ? 'px-4 py-2 rounded-lg text-[9px] font-black bg-mkYellow text-black transition' : 'px-4 py-2 rounded-lg text-[9px] font-black opacity-30 transition';
            syncDisplay();
        }

        // --- SYSTEME D'AUTHENTIFICATION ---
        async function processAuth() {
            const e = document.getElementById('in-email').value.trim();
            const u = document.getElementById('in-user').value.trim();
            const p = document.getElementById('in-pass').value.trim();
            if(!e || !p) return toast("Veuillez remplir les champs", "mkRed");

            let { data: prof, error } = await sb.from('profiles').select('*').eq('email', e).maybeSingle();

            if(!prof) {
                // Cr√©ation nouveau compte
                const { data, error: insErr } = await sb.from('profiles').insert([{
                    email: e, username: u || "Membre_"+Math.floor(Math.random()*9000),
                    password: p, balance: 10, xp: 0, 
                    pfp: `https://api.dicebear.com/7.x/pixel-art/svg?seed=${e}`,
                    tv_access: false, banned: false
                }]).select().single();
                if(insErr) return toast("Erreur cr√©ation", "mkRed");
                prof = data; toast("Bienvenue ! Cadeau de 10‚Ç¨", "mkGreen");
            } else {
                // Connexion existante
                if(prof.password !== p) return toast("Mot de passe incorrect", "mkRed");
                if(prof.banned) return toast("ACC√àS R√âVOQU√â (BAN)", "mkRed");
                toast("Bon retour sur MK Shop !");
            }

            user = prof;
            localStorage.setItem('mk_session_v69', JSON.stringify(user));
            closeModal('modal-auth');
            initApp();
        }

        function initApp() {
            if(!user) return;
            document.getElementById('auth-zone').classList.add('hidden');
            document.getElementById('user-zone').classList.remove('hidden');
            document.getElementById('u-pfp').src = user.pfp;
            if(user.username.toLowerCase() === 'admin') document.getElementById('nav-admin').classList.remove('hidden');
            if(user.tv_access) {
                document.getElementById('tv-action').innerHTML = `
                    <div class="bg-mkPurple/10 border border-mkPurple/30 p-6 rounded-3xl text-center">
                        <p class="text-mkPurple font-black text-[10px] uppercase mb-4 tracking-widest">Abonnement VIP Actif</p>
                        <button onclick="showSection('tv')" class="w-full bg-mkPurple text-white py-4 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-mkPurple/20 animate-pulse">Entrer dans la salle</button>
                    </div>`;
            }
            syncDisplay();
            if(!chatLoop) chatLoop = setInterval(loadChat, 3000); // Rafra√Æchissement silencieux
        }

        function syncDisplay() {
            if(!user) return;
            const el = document.getElementById('val-display');
            if(currentMode === 'cash') { el.innerText = user.balance.toFixed(2) + "‚Ç¨"; el.className = "font-black text-sm text-mkGreen"; }
            else { el.innerText = user.xp + " XP"; el.className = "font-black text-sm text-mkYellow"; }
        }

        // --- CASINO & GAINS ---
        async function updateStats(newBalance, addXp=10) {
            const { data, error } = await sb.from('profiles').update({ 
                balance: newBalance, 
                xp: user.xp + addXp 
            }).eq('id', user.id).select().single();
            if(data) { user = data; syncDisplay(); renderProfile(user); }
        }

        async function playGame(type, side) {
            if(!user) return toast("Connectez-vous d'abord", "mkRed");
            const bet = parseFloat(document.getElementById('bet-'+type).value);
            if(bet > user.balance || bet <= 0) return toast("Fonds insuffisants", "mkRed");

            if(type === 'coin') {
                const win = Math.random() > 0.55; // 45% de chance de gagner
                document.getElementById('coin-res').style.transform = "rotateY(720deg)";
                setTimeout(async () => {
                    document.getElementById('coin-res').style.transform = "none";
                    document.getElementById('coin-res').innerText = win ? (side === 'pile' ? 'ü™ô' : 'üü°') : (side === 'pile' ? 'üü°' : 'ü™ô');
                    await updateStats(win ? user.balance + bet : user.balance - bet, 25);
                    toast(win ? "MAGNIFIQUE GAGN√â !" : "DOMMAGE PERDU", win ? 'mkGreen' : 'mkRed');
                }, 500);
            }

            if(type === 'slots') {
                const s = ['üíé','üçí','üçã','üçá','‚≠ê'];
                const r = [s[Math.floor(Math.random()*5)], s[Math.floor(Math.random()*5)], s[Math.floor(Math.random()*5)]];
                document.getElementById('sl1').innerText = r[0]; document.getElementById('sl2').innerText = r[1]; document.getElementById('sl3').innerText = r[2];
                let mult = 0;
                if(r[0]===r[1] && r[1]===r[2]) mult = 15; else if(r[0]===r[1] || r[1]===r[2] || r[0]===r[2]) mult = 2;
                await updateStats((user.balance - bet) + (bet * mult), 40);
                if(mult > 0) toast("JACKPOT COMBO x"+mult, "mkPurple");
            }
        }

        // --- CHAT GLOBAL (SILENT REFRESH) ---
        async function sendChatMessage() {
            const i = document.getElementById('chat-input');
            if(!user || !i.value.trim()) return;
            const msg = i.value.trim();
            i.value = ""; // Efface imm√©diatement pour fluidit√©
            
            const { error } = await sb.from('messages').insert([{
                username: user.username, 
                content: msg, 
                pfp: user.pfp, 
                level: Math.floor(user.xp/150)
            }]);
            
            if(error) { toast("Erreur d'envoi", "mkRed"); i.value = msg; }
            else { loadChat(); }
        }

        async function loadChat() {
            const { data, error } = await sb.from('messages').select('*').order('created_at', { ascending: false }).limit(30);
            if(!data || error) return;

            // Syst√®me de refresh silencieux : on ne touche au DOM que s'il y a du nouveau
            if(data.length === lastMsgCount) return;
            lastMsgCount = data.length;

            const chatFlow = document.getElementById('chat-flow');
            chatFlow.innerHTML = data.reverse().map(m => `
                <div class="flex gap-4 items-start animate-view group">
                    <img src="${m.pfp}" class="w-10 h-10 rounded-2xl object-cover shadow-lg border border-white/5">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[7px] font-black bg-mkBlue/10 text-mkBlue px-2 py-0.5 rounded-lg uppercase tracking-widest border border-mkBlue/20">LVL ${m.level || 0}</span>
                            <b class="text-[10px] uppercase tracking-tighter text-white/90">${m.username}</b>
                        </div>
                        <p class="text-[11px] text-white/60 leading-relaxed font-medium">${m.content}</p>
                    </div>
                </div>
            `).join('');
            
            chatFlow.scrollTop = chatFlow.scrollHeight;
        }

        // --- TICKETS, PROMOS & TV ---
        async function openTicket(type) {
            if(!user) return toast("Connectez-vous !", "mkRed");
            const { error } = await sb.from('tickets').insert([{ 
                username: user.username, 
                type: type, 
                status: 'open', 
                content: 'Demande utilisateur' 
            }]);
            if(!error) toast("Ticket cr√©√© ! L'admin va vous contacter", "mkGreen");
        }

        async function unlockTV() {
            const code = document.getElementById('tv-code').value.toUpperCase();
            if(code === 'TVVIP' || code === 'SUPREME') {
                const { data } = await sb.from('profiles').update({ tv_access: true }).eq('id', user.id).select().single();
                user = data; initApp(); toast("Acc√®s Cinema d√©bloqu√© √† vie !", "mkPurple");
            } else { toast("Code invalide", "mkRed"); }
        }

        async function usePromo() {
            const c = document.getElementById('promo-code').value.toUpperCase();
            if(c === 'LXS-1' || c === 'MK69') {
                await updateStats(user.balance + 15, 100);
                toast("+15.00‚Ç¨ ajout√©s au compte !", "mkGreen");
            }
            document.getElementById('promo-code').value = "";
        }

        // --- ADMIN & PROFIL ---
        async function loadAdminPanel() {
            const { data: tickets } = await sb.from('tickets').select('*').eq('status', 'open');
            const { data: usersList } = await sb.from('profiles').select('*').order('created_at', { ascending: false });
            
            document.getElementById('adm-tickets').innerHTML = tickets.map(t => `
                <div class="glass p-5 rounded-2xl flex justify-between items-center border-l-4 border-mkRed animate-view">
                    <div>
                        <b class="text-[10px] uppercase block">${t.type}</b>
                        <span class="text-[9px] opacity-40 font-bold uppercase tracking-widest">Client: ${t.username}</span>
                    </div>
                    <button onclick="closeTicket('${t.id}')" class="bg-mkRed text-white px-4 py-2 rounded-xl text-[8px] font-black uppercase">Terminer</button>
                </div>
            `).join('');

            document.getElementById('adm-users').innerHTML = usersList.map(u => `
                <div class="glass p-5 rounded-2xl space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <img src="${u.pfp}" class="w-10 h-10 rounded-xl">
                            <div class="text-[10px] font-black uppercase">${u.username}<br><span class="text-mkBlue font-mono lowercase opacity-60">${u.password}</span></div>
                        </div>
                        <div class="text-right">
                            <p class="text-mkGreen font-black text-xs">${u.balance.toFixed(2)}‚Ç¨</p>
                            <p class="text-[8px] font-bold opacity-30">${u.email}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="adminMod('${u.id}', 'balance', 50)" class="flex-1 bg-mkGreen/10 text-mkGreen py-2 rounded-lg text-[8px] font-black">+50‚Ç¨</button>
                        <button onclick="adminMod('${u.id}', 'balance', -50)" class="flex-1 bg-mkRed/10 text-mkRed py-2 rounded-lg text-[8px] font-black">-50‚Ç¨</button>
                        <button onclick="adminMod('${u.id}', 'banned', ${!u.banned})" class="flex-1 ${u.banned ? 'bg-mkGreen' : 'bg-mkRed'}/10 text-mkAdmin py-2 rounded-lg text-[8px] font-black">${u.banned ? 'D√âBANNIR' : 'BANNIR'}</button>
                    </div>
                </div>
            `).join('');
        }

        async function adminMod(id, field, val) {
            let change = {};
            if(field === 'balance') {
                const { data } = await sb.from('profiles').select('balance').eq('id', id).single();
                change.balance = data.balance + val;
            } else { change[field] = val; }
            await sb.from('profiles').update(change).eq('id', id);
            loadAdminPanel();
            toast("Action Admin effectu√©e");
        }

        async function closeTicket(id) { await sb.from('tickets').update({ status: 'closed' }).eq('id', id); loadAdminPanel(); }

        function renderProfile(u) {
            if(!u) return;
            document.getElementById('p-avatar').src = u.pfp;
            document.getElementById('p-username').innerText = u.username;
            document.getElementById('p-val-cash').innerText = u.balance.toFixed(2) + "‚Ç¨";
            document.getElementById('p-val-xp').innerText = u.xp + " XP";
            document.getElementById('p-controls').classList.toggle('hidden', u.id !== user.id);
        }

        async function findMember() {
            const name = document.getElementById('search-name').value.trim();
            const { data } = await sb.from('profiles').select('*').eq('username', name).maybeSingle();
            if(data) renderProfile(data); else toast("Utilisateur introuvable", "mkRed");
        }

        async function updatePfp() {
            const url = document.getElementById('new-pfp-url').value;
            if(!url) return;
            const { data } = await sb.from('profiles').update({ pfp: url }).eq('id', user.id).select().single();
            user = data; initApp(); renderProfile(user); toast("Avatar mis √† jour !");
        }

        async function loadLeaderboard() {
            const { data } = await sb.from('profiles').select('*').order('balance', { ascending: false }).limit(10);
            document.getElementById('leader-container').innerHTML = data.map((u, i) => `
                <div class="flex justify-between items-center p-6 border-b border-white/5 hover:bg-white/5 transition">
                    <div class="flex items-center gap-5">
                        <span class="text-2xl font-black italic text-white/10 w-8">#${i+1}</span>
                        <img src="${u.pfp}" class="w-12 h-12 rounded-2xl shadow-lg border border-white/10">
                        <div>
                            <b class="text-sm uppercase tracking-tighter">${u.username}</b>
                            <p class="text-[9px] font-black text-mkYellow uppercase tracking-widest">${u.xp} XP</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <b class="text-mkGreen text-lg">${u.balance.toFixed(2)}‚Ç¨</b>
                    </div>
                </div>
            `).join('');
        }

        // --- HELPERS ---
        function toggleChat() { 
            const c = document.getElementById('mini-chat'); 
            c.style.display = c.style.display === 'flex' ? 'none' : 'flex'; 
            if(c.style.display === 'flex') loadChat(); 
        }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { localStorage.removeItem('mk_session_v69'); location.reload(); }
        function setFilm(url) { document.getElementById('tv-frame').src = url; }

        window.onload = () => {
            const saved = localStorage.getItem('mk_session_v69');
            if(saved) { user = JSON.parse(saved); initApp(); }
        };
    </script>
</body>
</html>
